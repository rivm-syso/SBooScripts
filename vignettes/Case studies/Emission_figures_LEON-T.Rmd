---
title: "LEON-T_emission_figures"
author: "Anne Hids"
date: "`r Sys.Date()`"
output: github_document
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r load data}

library(ggplot2)
library(tidyverse)
library(scales)
library(openxlsx)

data_folder <-  "vignettes/Case Studies/CaseData/"

```

# Prepare data for plotting
```{r}

MFAtype <- "DPMFA"

load(file = paste0(data_folder, MFAtype, "_EU", ".Rdata"))

data_long_EU <- 
  DPMFA_inflow |> unnest(Mass_Polymer_kt, keep_empty = TRUE) |> 
  pivot_longer(cols=-c(Type, Scale, Source, Polymer, To_Compartment, Material_Type, iD_source, RUN),
               names_to = "Year",
               values_to = "Mass_Polymer_kt") |>
  select(-c(Scale, iD_source))

load(file = paste0(data_folder, MFAtype, "_NL", ".Rdata"))

data_long_NL <-
  DPMFA_inflow |> unnest(Mass_Polymer_kt, keep_empty = TRUE) |>
  pivot_longer(cols=-c(Type, Scale, Source, Polymer, To_Compartment, Material_Type, iD_source, RUN),
               names_to = "Year",
               values_to = "Mass_Polymer_kt") |>
  select(-c(Scale, iD_source))

data_long <- data_long_EU  |>
  left_join(data_long_NL, by = c("Type", "Source", "Polymer", "To_Compartment", "Material_Type", "RUN", "Year")) |>
  mutate(Mass_Polymer_kt = Mass_Polymer_kt.x + Mass_Polymer_kt.y) |>
  select(-c(Mass_Polymer_kt.x, Mass_Polymer_kt.y)) |>
  mutate(Scale = "EU")

###################### Dataframe manipulation for plots ########################

Years_available <- unique(data_long$Year)

SelectYear = 2019

# Create a dataframe for just selectyear
data_Year <- data_long |>
  filter(Year == SelectYear) |>
  mutate(Mass_Polymer_t = Mass_Polymer_kt * 1000, .keep = "unused") |> # conert kt to ton
  filter(To_Compartment %in% unique(DPMFA_sink$To_Compartment) & Type == "Inflow") |> # only sinks
  mutate(`Environmental_compartment` = # make column indicating of this an air, water or soil sink.
           case_when(
             str_detect(To_Compartment, 'water') ~ "water",
             str_detect(To_Compartment, 'air') ~ "air",
             str_detect(To_Compartment, 'soil') ~ "soil",
             .default = "none"
           )) |> filter(`Environmental_compartment` != "none") |> # remove sinks that are not environmental
  mutate(IenW_Source = # aggregate inputs to the Major sources classes the study focusses on
           case_when(
             str_detect(Source, 'Clothing') ~ "Textile",
             str_detect(Source, 'Household textiles') ~ "Textile",
             str_detect(Source, 'Technical textiles') ~ "Textile", 
             str_detect(Source, 'Import of primary plastics') ~ "Pre-production pellets",
             str_detect(Source, 'Domestic primary plastic production') ~ "Pre-production pellets",
             .default = Source
           )) |>
  filter(!is.na(Mass_Polymer_t))
  
data_Year_sep_macro <- 
  data_Year |> filter(Material_Type == "micro") |> full_join(
    data_Year |> 
      filter(Material_Type == "macro") |> 
      ungroup() |> 
      group_by(Type   ,
               Scale,
               Polymer,
               To_Compartment,
               Material_Type,
               RUN,
               Year,
               Environmental_compartment) |> 
      summarise(Mass_Polymer_t = sum(Mass_Polymer_t),
                IenW_Source = "Macroplastic",
                Source = "Macroplastic")
  )

data_micro_summed_over_polymers <- data_Year |>
  filter(Material_Type == "micro") |>
  group_by(Type, Scale, Source, To_Compartment, Material_Type, RUN, Year, Environmental_compartment, IenW_Source) |>
  summarise(Mass_Polymer_t = sum(Mass_Polymer_t))

```

```{r}
# Create a theme for the plots
plot_theme = theme(
  axis.title.x = element_text(size = 32),
  legend.text = element_text(size = 26),
  axis.text = element_text(size = 26), 
  axis.title.y = element_text(size = 32),
  plot.background = element_rect(fill = 'white'),
  panel.background = element_rect(fill = 'white'),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(color='black'),
  plot.margin = margin(2, 4, 2, 2, "cm"),
  legend.title = element_blank()
  #panel.grid.major = element_line(colour = "grey",size=0.25)
)

# Define colors for groups
source_colors <- c(
  "Agriculture" = "#F8766D",
  "Clothing and home textiles" = "#E58700",
  "Intentionally produced microparticles" = "#C99800",
  "Macroplastic" = "#A3A500",
  "Packaging" = "#619cff",
  "Paint" = "#00BA38",
  "Pre-production pellets" = "#00C0AF",
  "Technical textiles" = "#00B0F6",
  "Textile" = "#B983FF",
  "Tyre wear" = "#ff67a4"
)

TW_other_colors <- c(
  "Tyre wear" = "#ff67a4",
  "Other sources" = "#619cff"
)

micro_macro_colors <- c(
  "Microplastic" = "#A3A500",
  "Macroplastic" = "#B983FF"
)

sink_colors <- c(
  "water" = "dodgerblue4",
  "air" = "slategray3",
  "soil" = "darkgoldenrod"
)
```

Figure comparing micro with macro emissions

```{r Micro macro}
micro_macro <- data_Year_sep_macro |>
  group_by(Material_Type, RUN)|>
  summarise(Mass_Polymer_t = sum(Mass_Polymer_t)) |>
  mutate(Material_Type =case_when(
    Material_Type == "micro" ~ "Microplastic",
    Material_Type == "macro" ~ "Macroplastic"
  ))

micro_macro_plot <- ggplot(micro_macro, aes(x = Material_Type, y = Mass_Polymer_t, fill=Material_Type)) +
  geom_violin() +
  scale_fill_manual(values = micro_macro_colors) +
  theme(legend.position="none")+
  scale_y_log10(labels = scales::number_format())+          
  labs(x = "", y = "Total plastic emissions (ton)") +                   # Adjust labels
  coord_flip() +
  plot_theme 

micro_macro_plot

ggsave(paste0("/Figures/Emission_plots/","Micro_macro_",format(Sys.time(),'%Y%m%d'),".png"),
       path = data_folder, width = 20, height = 10)  
```

Figure comparing microplastic emissions tyre wear with other microplastic emissions
```{r}
Data_TW_separated <- data_micro_summed_over_polymers |>
  mutate(TW_class = ifelse(Source == "Tyre wear", "Tyre wear", "Other sources"))

TW_Other_micro_plot <- ggplot(Data_TW_separated, aes(x = TW_class, y = Mass_Polymer_t, fill=TW_class)) +
  geom_violin() +
  scale_fill_manual(values = TW_other_colors) +
  theme(legend.position="none")+
  scale_y_log10(labels = scales::number_format())+          
  labs(x = "", y = "Microplastic emissions (ton)") +                   # Adjust labels
  coord_flip() +
  plot_theme 

TW_Other_micro_plot

ggsave(paste0("/Figures/Emission_plots/","TW_other_",format(Sys.time(),'%Y%m%d'),".png"),
       path = data_folder, width = 20, height = 10)  

```

TW to environmental compartments
```{r}
TW_data <- Data_TW_separated |>
  filter(Source == "Tyre wear") |>
  mutate(To_Compartment = str_remove(To_Compartment, fixed(" (micro)")))

TW_env_comp_plot <- ggplot(TW_data, aes(x = To_Compartment, y = Mass_Polymer_t, fill=To_Compartment)) +
  geom_violin() +
  theme(legend.position="none")+
  scale_y_log10(labels = scales::number_format())+          
  labs(x = "", y = "Microplastic emissions (ton)") +                   # Adjust labels
  coord_flip() +
  plot_theme 

TW_env_comp_plot

ggsave(paste0("/Figures/Emission_plots/","TW_to_env_comps_",format(Sys.time(),'%Y%m%d'),".png"),
       path = data_folder, width = 20, height = 10)  
```

Stacked barplot distribution over different sinks TWP vs. other sources
```{r}

barplot_data <-
  Data_TW_separated |> 
  ungroup() |> 
  group_by(Scale, TW_class, To_Compartment, Environmental_compartment, Year, Type, Material_Type) |> 
  summarise(Mass_Polymer_t = mean(Mass_Polymer_t),
            n = n()) |> 
  ungroup() |> 
  group_by(Scale, TW_class, Environmental_compartment, Year, Type) |> 
  summarise(Mass_Polymer_t = sum(Mass_Polymer_t),
            n= n())

#### sinks barplot ####
# Make a stacked barplot for what percentage goes to air, soil and water
sink_dist_barplot <- ggplot(barplot_data, aes(fill = Environmental_compartment, x = TW_class, y = Mass_Polymer_t)) +
  geom_bar(position = "fill", stat="identity", color = "transparent") +
  scale_fill_manual(values = sink_colors) +
  scale_x_discrete(labels = wrap_format(10)) +                   # Wraps text longer than 10 characters
  scale_y_continuous(labels = scales::percent) +
  plot_theme +
  labs(y= "Distribution",
       x="") +
  labs(fill='Sink type')
sink_dist_barplot

ggsave(paste0("/Figures/Emission_plots/","Env_comp_barplot_",format(Sys.time(),'%Y%m%d'),".png"),
       path = data_folder, width = 20, height = 10)  
```

# Simplebox figures

```{r load SB ouput data}
otherdataname <- "LEON-T_output_OTHER_DPMFA_10_RUNS_2024_10_30.RData"
twdataname <- "LEON-T_output_TYRE_WEAR_DPMFA_10_RUNS_2024_10_31.RData"

load(paste0(data_folder, otherdataname))
concentration_other <- concentration_df |>
  mutate(Source = "Other sources")
input_vars_other <- input_var_df
solution_other <- solved_df |>
  mutate(Source = "Other sources")

load(paste0(data_folder, twdataname))
concentration_tw <- concentration_df |>
  mutate(Source = "Tyre wear")
input_vars_tw <- input_var_df
solution_tw <- solved_df |>
  mutate(Source = "Tyre wear")

concentration_df <- rbind(concentration_other, concentration_tw)
solution_df <- rbind(solution_other, solution_tw)

```

# Prep data and make plots
```{r Initialize theme}

# Create a plot theme
plot_theme <-  theme(
  axis.title.x = element_text(size = 14),    
  axis.title.y = element_text(size = 14),    
  axis.text.x = element_text(size = 12, angle = 45, hjust = 1),     
  axis.text.y = element_text(size = 12),
  title = element_text(size=20),
  panel.background = element_rect(fill = "white"),  
  panel.grid.major = element_line(color = "lightgrey", size = 0.5),  
  panel.grid.minor = element_line(color = "lightgrey", size = 0.5)
)

```

```{r Plot SB output}
if(MFAtype == "PMFA"){
  
  
  
  
} else if (MFAtype == "DPMFA"){
  concentration_long <- concentration_df |>
    pivot_longer(!c(time, RUN, Polymer, Source), names_to = "Abbr", values_to = "Concentration") |>
    mutate(time = as.numeric(time)) |>
    mutate(RUN = as.integer(RUN)) |>
    mutate(concentration = as.double(Concentration)) |>
    mutate(Year = time/(365*24*3600))
}

```

```{r Make Mass plots}

if(MFAtype == "PMFA"){
  for(name in solved_df_names){
    solution_name <- name
    
    Solution <- get(solution_name)$SteadyStateMass |>
      mutate(RUN = as.integer(RUN)) |>
      mutate(EqMass = as.double(EqMass)) 
    
    source <- str_remove(solution_name, "solved_ss_") |> 
          str_replace("_[^_]*$", "") |>  # Removes everything after the last underscore
          str_replace_all("_", " ")      # Replaces all underscores with spaces
    
    pol <- str_extract(solution_name, "(?<=_)[^_]*$")
    
    subt <- paste0(source, ", ", pol, ", ", y)
    
    # Aggregate plot data for all species
    Plot_data_agg <- Solution |>
      mutate(SubCompart = case_when(
        SubCompart == "cloudwater" ~ "air",
        TRUE ~ SubCompart
      )) |>
      group_by(Scale, SubCompart, RUN, Unit) |>
      summarise(EqMass = sum(EqMass)) 
      
    scales <- unique(Plot_data_agg$Scale)
    
    # Make plots for each scale
    for (scale in scales) {
      plot_data_scale <- Plot_data_agg |>
        filter(Scale == scale) |>
        mutate(concname = paste0(SubCompart, " (", Unit, ")"))
      
      # Filter out the compartments without mass
      masscomps <- plot_data_scale |>
        filter(RUN == 1) |>
        filter(EqMass != 0)
      
      masscomps <- masscomps$SubCompart
      
      plot_data_scale <- plot_data_scale |>
        filter(SubCompart %in% masscomps) 
      
      # Mass plot
      mass_p <- ggplot(plot_data_scale, mapping = aes(x = SubCompart, y = EqMass, fill = SubCompart)) +  
        geom_violin() + 
        labs(title = paste0("Masses at ", scale, " scale"),
             subtitle = subt,
             x = "Compartment",
             y = "Mass (kg)") +
        plot_theme +
        scale_y_continuous(trans = 'log10') +
        scale_fill_viridis_d() + 
        theme(axis.text.x = element_blank(),  
              legend.position = "bottom") +   
        guides(fill = guide_legend(title = NULL)) + 
      scale_y_log10(  # Apply logarithmic scale
      # Major breaks at powers of 10
      breaks = scales::trans_breaks("log10", function(x) 10^x),
      
      # Labels in human-readable form
      labels = scales::trans_format("log10", scales::math_format(10^.x)),
    ) 
      
      print(mass_p)
      
      ggsave(paste0("vignettes/Case Studies/CaseData/Mass_plot_", scale,  "_", date, "_", runs, "runs.png"), plot=mass_p)
    }
  }
} else if(MFAtype == "DPMFA"){
  for(name in solved_df_names){
    solution_name <- name
    
    Solution <- get(solution_name)$SteadyStateMass |>
      mutate(RUN = as.integer(RUN)) |>
      mutate(EqMass = as.double(EqMass)) 
    
    source <- str_remove(solution_name, "solved_ss_") |> 
          str_replace("_[^_]*$", "") |>  # Removes everything after the last underscore
          str_replace_all("_", " ")      # Replaces all underscores with spaces
    
    pol <- str_extract(solution_name, "(?<=_)[^_]*$")
    
    subt <- paste0(source, ", ", pol, ", ", y)
    
    # Aggregate plot data for all species
    Plot_data_agg <- Solution |>
      mutate(SubCompart = case_when(
        SubCompart == "cloudwater" ~ "air",
        TRUE ~ SubCompart
      )) |>
      group_by(Scale, SubCompart, RUN, Unit) |>
      summarise(EqMass = sum(EqMass)) 
      
    scales <- unique(Plot_data_agg$Scale)
    
    # Make plots for each scale
    for (scale in scales) {
      plot_data_scale <- Plot_data_agg |>
        filter(Scale == scale) |>
        mutate(concname = paste0(SubCompart, " (", Unit, ")"))
      
      # Filter out the compartments without mass
      masscomps <- plot_data_scale |>
        filter(RUN == 1) |>
        filter(EqMass != 0)
      
      masscomps <- masscomps$SubCompart
      
      plot_data_scale <- plot_data_scale |>
        filter(SubCompart %in% masscomps) 
      
      # Mass plot
      mass_p <- ggplot(plot_data_scale, mapping = aes(x = SubCompart, y = EqMass, fill = SubCompart)) +  
        geom_violin() + 
        labs(title = paste0("Masses at ", scale, " scale"),
             subtitle = subt,
             x = "Compartment",
             y = "Mass (kg)") +
        plot_theme +
        scale_y_continuous(trans = 'log10') +
        scale_fill_viridis_d() + 
        theme(axis.text.x = element_blank(),  
              legend.position = "bottom") +   
        guides(fill = guide_legend(title = NULL)) + 
      scale_y_log10(  # Apply logarithmic scale
      # Major breaks at powers of 10
      breaks = scales::trans_breaks("log10", function(x) 10^x),
      
      # Labels in human-readable form
      labels = scales::trans_format("log10", scales::math_format(10^.x)),
    ) 
      
      print(mass_p)
      
      ggsave(paste0("vignettes/Case Studies/CaseData/Mass_plot_", scale,  "_", date, "_", runs, "runs.png"), plot=mass_p)
    }
  }
}
```



```{r Make concentration plots}
if(type == "PMFA"){
  for(name in concentration_df_names){
    solution_name <- name
    
    Solution <- get(solution_name) |>
      mutate(RUN = as.integer(RUN)) |>
      mutate(Concentration = as.double(Concentration)) 
    
    source <- str_remove(solution_name, "concentration_ss_") |> 
          str_replace("_[^_]*$", "") |>  # Removes everything after the last underscore
          str_replace_all("_", " ")      # Replaces all underscores with spaces
    
    pol <- str_extract(solution_name, "(?<=_)[^_]*$")
    
    subt <- paste0(source, ", ", pol, ", ", y)
    
    # Aggregate plot data for all species
    Plot_data_agg <- Solution |>
      group_by(Scale, SubCompart, RUN, Unit) |>
      summarise(Concentration = sum(Concentration)) 
      
    scales <- unique(Plot_data_agg$Scale)
    
    # Make plots for each scale
    for (scale in scales) {
      plot_data_scale <- Plot_data_agg |>
        filter(Scale == scale) |>
        mutate(concname = paste0(SubCompart, " (", Unit, ")"))
      
      # Filter out the compartments without mass
      masscomps <- plot_data_scale |>
        filter(RUN == 1) |>
        filter(Concentration != 0)
      
      masscomps <- masscomps$SubCompart
      
      plot_data_scale <- plot_data_scale |>
        filter(SubCompart %in% masscomps) 
      
      # Concentration plot
      conc_p <- ggplot(plot_data_scale, mapping = aes(x = concname, y = Concentration, fill = concname)) +  
        geom_violin() +
        labs(title = paste0("Concentrations at ", scale, " scale"),
             subtitle = subt,
             x = "Compartment",
             y = "Concentration") +
        plot_theme +
        scale_y_continuous(trans = 'log10') +
        scale_fill_viridis_d() +
        theme(axis.text.x = element_blank(),  
              legend.position = "bottom") +   
        guides(fill = guide_legend(title = NULL))  + 
      scale_y_log10(  # Apply logarithmic scale
      # Major breaks at powers of 10
      breaks = scales::trans_breaks("log10", function(x) 10^x),
      
      # Labels in human-readable form
      labels = scales::trans_format("log10", scales::math_format(10^.x)),
    ) 
      
      print(conc_p)
      
      ggsave(paste0("vignettes/Case Studies/CaseData/Concentration_plot_", scale, "_", date, "_", runs, "runs.png"), plot=conc_p)
    }
  }
} else if(type == "DPMFA"){
  for(name in solved_df_names){
    
  }
}

```





