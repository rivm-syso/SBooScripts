---
title: "excel2DAG"
author: "JS"
date: "`r Sys.Date()`"
output: html_document
header-includes:
  - \usepackage{tikz}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!file.exists("baseScripts/fakeLib.R")){
projectRoot <- paste(getwd(), "..", sep = "/")
knitr::opts_knit$set(root.dir = projectRoot) #assuming vignette is in a direct subfolder of the project
}
```

## Trace precedents / dependancies
This vignette creates a Directed Graph from formulas in excel. It demonstrates the further use of the ClassicNanoProcess, especially the methods Excelgrep, Exceldependencies and Exceltrace, in combination with igraph. The end result is a plotted graph which gives you inside in the coherence of the waterflows and the related exchange-rates.

First we initialise a landscape "World", and grab cells with names containing "flow" or "Ocean", and their contents
```{r startWorld, include = FALSE}
#script to initialize test environment faking library(sboo)
source("baseScripts/fakeLib.R", verbose = F) #TODO silence the source
NewstateModule <- ClassicNanoWorld$new("data", "Ag(I)")
#with this data we create an instance of the central "core" object,
World <- SBcore$new(NewstateModule)
#reading data from the excel version(s) resembles the process class 
ClassicClass <- ClassicNanoProcess$new(TheCore = World, filename = "data/SimpleBox4.01_20211028.xlsm")
World$UpdateKaas(ClassicClass)

#TODO rename .1 columns?
```
We use the Excelgrep method to extract the cells with names like flow or Ocean. If you're not familiar with grep: it's ancient and amazingly powerful!
The Scale and Subcompart columns are based on the naming convention in the SB excel versions
```{r}
flows <- ClassicClass$Excelgrep("flow|Ocean")
flows[,c("Scale","Scale.1","SubCompart","SubCompart.1","varName", "FormValue")]
```

## Track and Trace
We back-track the dependencies of these cells, but we limit the tracking-depth (maxDepth) to avoid cluttering of the graph. To filter the data data to our needs, we convert the graph temporarily to a data.frame.

```{r dependanciesTrace, echo=FALSE, include = FALSE}
All2Nodes <- ClassicClass$Exceldependencies(flows$varName, maxDepth = 2)
asDF <- igraph::as_data_frame(All2Nodes)  #as.data.frame(All2Nodes)
asDF <- asDF[grep("flow|TAU|Ocean", asDF$from) ,]
```

## Concatenate another selection
To complete the graph we have to add a "layer" to the other side: the trace of the cell. The unique function makes sure there are no double edges between the original graph and the novel part. We can use the original plot function from igraph, but making nice graphs needs some proper AI to make it look good...
Further information can be added to graph by colors. In this case I'm focussing on the scales Continental (trailing C in the name) and Regional (trailing R). I also substituted the SubCompartment codes to more verbose ones.
```{r Concatenate, echo=FALSE, include = FALSE}
#The include = FALSE is the only way I can get rid of the igraph verbosity
k_part <- ClassicClass$Exceltrace(asDF$to, maxDepth = 2)
k_part <- igraph::as_data_frame(k_part)  
fromAndTo <- unique(rbind(asDF, k_part))
#If you are dazzled by the subcompartment abbreviations, you can search and replace them..
fromAndTo$from <- gsub("w0", "lake", fromAndTo$from)
fromAndTo$from <- gsub("w1", "river", fromAndTo$from)
fromAndTo$from <- gsub("w2", "sea", fromAndTo$from)
fromAndTo$from <- gsub("w3", "dpOcean", fromAndTo$from)
fromAndTo$to <- gsub("w0", "lake", fromAndTo$to)
fromAndTo$to <- gsub("w1", "river", fromAndTo$to)
fromAndTo$to <- gsub("w2", "sea", fromAndTo$to)
fromAndTo$to <- gsub("w3", "dpOcean", fromAndTo$to)
TheGraph <- igraph::graph_from_data_frame(fromAndTo)
vertices <- names(igraph::V(TheGraph))
vertLastChar <- substr(vertices, start = nchar(vertices), stop = nchar(vertices))
Vcolor <- sapply(vertLastChar, switch,
            "C" = "brown",
            "R" = "darkgreen",
            "grey") #else

igraph::V(TheGraph)[]$color <- Vcolor
```

```{r, fig.width = 12}
plot(TheGraph)
```
ggdag also makes nice output, and also needs the right parameters... paste the resulting string into the modelstring at the following url:
http://dagitty.net/dags.html
```{r AsGGdag, echo=FALSE}
NodeAsText <- paste(fromAndTo$from, "->" ,fromAndTo$to)
AllNodesAsText <- do.call(paste, c(as.list(NodeAsText), list(sep = ";")))
paste("dag{", AllNodesAsText, "}")
#local: 
#dag <- dagitty::dagitty(paste("dag{", AllNodesAsText, "}"))
#ggdag(dag, text_col = "black", text_size = 2, node_size = 0)
```
I made the picture below using the link and the graph created above; the text version in the Rmd code originates from that webpage.

(<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" width="1169" height="1219" style="font-family: Arial, sans-serif"><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M549.27,303.38L503.58,435.01"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(503.5787915386538,435.0051502406587) rotate(-70.85681787200195)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M319.31,290.11L363.13,224.53"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(363.1329254322516,224.5274706902145) rotate(123.750748030605)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M394.68,215.01L533.00,280.22"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(533.0048272725862,280.22304802805814) rotate(205.2405525375641)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M548.40,196.01L553.54,269.13"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(553.5426464514137,269.1342932835081) rotate(265.9764440264238)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M210.49,130.41L193.64,232.07"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(193.6422637618507,232.06921902610733) rotate(-80.58936248834783)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M207.48,258.49L286.07,294.36"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(286.0735710583941,294.3585424174841) rotate(204.5315312715158)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M396.67,205.26L522.43,184.47"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(522.4340461709545,184.46907921699886) rotate(170.61269949172052)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M575.10,286.79L696.28,270.08"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(696.2757838829862,270.075914731396) rotate(172.14772576464657)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M746.62,383.69L726.16,286.76"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(726.1575371224327,286.7598011229677) rotate(78.08167960813459)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M731.00,254.21L793.01,155.32"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(793.0075725677598,155.320070495201) rotate(122.08806986473175)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M568.74,714.32L586.06,626.08"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(586.0551494186525,626.082652149995) rotate(101.10194176669626)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M171.21,525.32L200.95,580.57"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(200.94563050755127,580.5694793417778) rotate(241.7116763832896)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M891.12,470.72L875.16,547.45"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(875.1590115815752,547.4481198093181) rotate(-78.25170244636459)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M578.60,740.14L633.46,796.29"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(633.4646621373744,796.2938152089348) rotate(225.66424563995264)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M123.95,821.97L198.05,817.29"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(198.053351514334,817.290509549315) rotate(176.38819634628513)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M483.31,465.76L413.52,548.53"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(413.5181890120425,548.5303242158485) rotate(-49.86348312690921)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M382.80,222.36L424.33,348.30"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(424.32605627602476,348.2983412179913) rotate(251.75149221152375)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M564.92,302.25L621.47,397.79"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(621.4686481943002,397.7910529118296) rotate(239.38187310808541)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M176.90,263.40L113.79,334.72"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(113.7906250507868,334.721473975869) rotate(-48.49545656987141)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M304.52,317.48L279.96,425.23"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(279.95904642450387,425.23261524862164) rotate(-77.16153265224223)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M564.91,187.80L620.34,214.05"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(620.3396313886292,214.0488975214786) rotate(205.3428239805628)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M738.46,274.54L809.64,311.29"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(809.6370391048566,311.29055219350437) rotate(207.30903287220056)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M824.76,133.05L895.98,108.25"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(895.9771038622164,108.24773611912141) rotate(160.80000644832893)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M606.56,597.15L662.52,555.55"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(662.5181125514262,555.5467532212091) rotate(143.36920607760186)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M228.43,607.54L315.31,672.83"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(315.3146050090773,672.8289171084944) rotate(216.9229297153255)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M202.86,610.93L154.22,688.13"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(154.22118420111318,688.1314402630574) rotate(-57.785254330501886)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M857.03,578.42L789.72,651.28"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(789.724487625186,651.2787018514967) rotate(-47.27027315665175)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M883.53,578.05L945.60,640.79"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(945.602289681924,640.7869593704298) rotate(225.30320711189592)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M670.82,810.81L731.51,811.81"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(731.5117945780917,811.8133723190724) rotate(180.9517136579044)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M239.99,823.92L328.48,873.97"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(328.4796903376768,873.968122450745) rotate(209.49160608574)"></path></g><g class="path" style="cursor: move;"><path stroke="black" stroke-width="1.5" fill="none" d="M242.92,814.64L353.09,805.70"></path><path stroke="black" stroke-width="1.5" fill="white" class="arrowfront" d="M-1,0L15,5L15,-5Z" transform="translate(353.0922285131796,805.6956228472453) rotate(175.35657104223748)"></path></g><g style="cursor: move; touch-action: none;" transform="translate(555.3356748288769,289.0807986886029)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="156.43333435058594" height="17" x="-78.21666717529297" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w2R.w2C</text></g><g style="cursor: move; touch-action: none;" transform="translate(495.5600534368397,453.90561906671024)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="156.43333435058594" height="17" x="-78.21666717529297" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w0R.w1R</text></g><g style="cursor: move; touch-action: none;" transform="translate(308.6587571117184,302.8052905313292)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="156.43333435058594" height="17" x="-78.21666717529297" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w1C.w1R</text></g><g style="cursor: move; touch-action: none;" transform="translate(377,208)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="156.43333435058594" height="17" x="-78.21666717529297" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w1R.w2R</text></g><g style="cursor: move; touch-action: none;" transform="translate(547.0534944542829,181.04034596719978)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="156.43333435058594" height="17" x="-78.21666717529297" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w2C.w2R</text></g><g style="cursor: move; touch-action: none;" transform="translate(213.5505500550068,115.5801895757038)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="156.43333435058594" height="17" x="-78.21666717529297" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w1C.w2C</text></g><g style="cursor: move; touch-action: none;" transform="translate(189.57334926560884,251.7917645222934)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="156.43333435058594" height="17" x="-78.21666717529297" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w0C.w1C</text></g><g style="cursor: move; touch-action: none;" transform="translate(721.0101014785712,267.2058984504797)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="158.21665954589844" height="17" x="-79.10832977294922" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w2C.w2M</text></g><g style="cursor: move; touch-action: none;" transform="translate(750.4915926168923,398.41206008099255)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="67.25" height="17" x="-33.625" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">TAU.w2C</text></g><g style="cursor: move; touch-action: none;" transform="translate(806.0481457587746,138.3600367175353)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="158.21665954589844" height="17" x="-79.10832977294922" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w2M.w2C</text></g><g style="cursor: move; touch-action: none;" transform="translate(565.1060643298982,729.0702654801781)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="100.51667022705078" height="17" x="-50.25833511352539" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">OceanCurrent</text></g><g style="cursor: move; touch-action: none;" transform="translate(590.8863227880972,606.4750007381957)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="157.3333282470703" height="17" x="-78.66666412353516" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w2M.w2A</text></g><g style="cursor: move; touch-action: none;" transform="translate(162,512)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="75.26667022705078" height="17" x="-37.63333511352539" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">TAU.surfM</text></g><g style="cursor: move; touch-action: none;" transform="translate(213,598)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="111.16666412353516" height="17" x="-55.58333206176758" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">OceanMixing.M</text></g><g style="cursor: move; touch-action: none;" transform="translate(895,456)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="72.5999984741211" height="17" x="-36.29999923706055" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">TAU.surfA</text></g><g style="cursor: move; touch-action: none;" transform="translate(870,567)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="108.5" height="17" x="-54.25" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">OceanMixing.A</text></g><g style="cursor: move; touch-action: none;" transform="translate(650.8238015959555,810.5369225571643)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="154.6666717529297" height="17" x="-77.33333587646484" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">WATERflow.w2T.w2M</text></g><g style="cursor: move; touch-action: none;" transform="translate(104,823)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="71.69999694824219" height="17" x="-35.849998474121094" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">TAU.surfT</text></g><g style="cursor: move; touch-action: none;" transform="translate(223,816)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="107.5999984741211" height="17" x="-53.79999923706055" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">OceanMixing.T</text></g><g style="cursor: move; touch-action: none;" transform="translate(397.67107816716464,563.8627004378873)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="80.9000015258789" height="17" x="-40.45000076293945" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w0R.w1R</text></g><g style="cursor: move; touch-action: none;" transform="translate(432.00018259541855,367.2935474468148)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="80.9000015258789" height="17" x="-40.45000076293945" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w1R.w2R</text></g><g style="cursor: move; touch-action: none;" transform="translate(634,415)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="80.9000015258789" height="17" x="-40.45000076293945" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w2R.w2C</text></g><g style="cursor: move; touch-action: none;" transform="translate(97.43269736140537,349.70476569752344)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="80.9000015258789" height="17" x="-40.45000076293945" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w0C.w1C</text></g><g style="cursor: move; touch-action: none;" transform="translate(274.4571324090568,444.7221339843076)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="80.9000015258789" height="17" x="-40.45000076293945" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w1C.w1R</text></g><g style="cursor: move; touch-action: none;" transform="translate(642.8760149739282,222.57643688193377)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="80.9000015258789" height="17" x="-40.45000076293945" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w2C.w2R</text></g><g style="cursor: move; touch-action: none;" transform="translate(831.6972014756265,320.5613252950926)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="82.68333435058594" height="17" x="-41.34166717529297" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w2C.w2M</text></g><g style="cursor: move; touch-action: none;" transform="translate(919.4969946250643,101.57101240041067)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="82.68333435058594" height="17" x="-41.34166717529297" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w2M.w2C</text></g><g style="cursor: move; touch-action: none;" transform="translate(682.4859358659978,543.6694927566006)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="81.80000305175781" height="17" x="-40.900001525878906" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w2M.w2A</text></g><g style="cursor: move; touch-action: none;" transform="translate(335,685)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="84.46666717529297" height="17" x="-42.233333587646484" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w2M.w3M</text></g><g style="cursor: move; touch-action: none;" transform="translate(141,705)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="84.46666717529297" height="17" x="-42.233333587646484" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w3M.w2M</text></g><g style="cursor: move; touch-action: none;" transform="translate(773,666)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="79.13333129882812" height="17" x="-39.56666564941406" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w2A.w3A</text></g><g style="cursor: move; touch-action: none;" transform="translate(963,655)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="79.13333129882812" height="17" x="-39.56666564941406" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w3A.w2A</text></g><g style="cursor: move; touch-action: none;" transform="translate(756.5081461275062,812.148691695551)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="79.13333129882812" height="17" x="-39.56666564941406" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w2T.w2M</text></g><g style="cursor: move; touch-action: none;" transform="translate(350,884)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="75.56666564941406" height="17" x="-37.78333282470703" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w2T.w3T</text></g><g style="cursor: move; touch-action: none;" transform="translate(378,804)"><path fill-opacity="0.7" stroke-width="2" z-index="1" d="M 0 0 m 20, 0 a 20,15 0 1,1 -40,0 a 20,15 0 1,1 40,0" fill="#aaaaaa" stroke="#666666"></path><rect class="textbg" fill="#ffffff" width="75.56666564941406" height="17" x="-37.78333282470703" y="21"></rect><text class="nodelabel" y="35" text-anchor="middle">k.w3T.w2T</text></g></svg>)

## The logic of rain-induced  regional / continental waterflows.
The next step is to find the formulas with this graph; I want to know the formulas of the Regional and Continental waterfluxes. From the graph I extract the order of the calculation. I exclude between sea and deepsea where it doesn't affect non-sea waterflows. The combination of the ordered list and the formula's / values from the flows data.frame is:
```{r corder}
#flows[flows$Scale %in% c("Regional", "Continental") | flows$Scale.1 %in% c("Regional", "Continental"), c("Scale","Scale.1","SubCompart","SubCompart.1","varName")]
corder <- match(c("WATERflow.w1C.w2C", "WATERflow.w0C.w1C", "WATERflow.w1C.w1R", "WATERflow.w1R.w2R", "WATERflow.w2C.w2R", "WATERflow.w2R.w2C", "WATERflow.w0R.w1R", "WATERflow.w0R.w1R"),
                flows$varName)
rownames(flows) <- flows$varName
flows[corder, c("FormValue", "varName")]
```

The runoff from soils and the direct rainfall on w1 (rivers = "freshwater") are available from the flux x_RunOff and the variable "RainOnRiver". There are also two fractions controlling the flux from Continental rivers to Regional, and visa versa: FRAC.w1C.w1R and FRAC.w1R.w1C. Use these if you clipping of Regional out of Continental is not 100% consistent with the catchments. FRAC.w1R.w1C is a landscape setting, 0.0 for the Default and EUSES scenarios. FRAC.w1C.w1R is also a landscape scenario set to 0 for Default, but 3.4 % for EUSES. The outflow of continental river to the sea is the rain-originating input, excluding the fraction to Regional river. The outflow from the lake to the river is 10% from the outflow of the river to the sea. (It is unclear where the lake water comes from. Also no mentioning of a flow from Regional rivers to Continental rivers in report-2015 and use of FRAC.w1R.w1C)
The outflow from Regional river is the rain-originating input plus the flow from Continental river

