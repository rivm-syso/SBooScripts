---
title: "DPMFA LEON-T"
author: "Anne Hids, Joris Quik"
date: "`r Sys.Date()`"
output: github_document
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::knit_meta()
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
projectRoot <- paste(getwd(), "..", "..", sep = "/")
knitr::opts_knit$set(root.dir = projectRoot) 
```

```{r Load packages}
library(tidyverse)
library(ggplot2)
```

# 01: Make emission dataframes for tyre wear and other sources and save them as RData files 

The sourced script reads in the DPMFA output data, and links the emissions to the relevant SimpleBox compartments. The 
emission data in kt/y is converted to kg/s. 
```{r 01 Make emission RData files}
# Make emission RData file for tyre wear
source_of_interest <- "Tyre wear"
source("vignettes/CaseStudies/01_get_Emission.R")

# Make emission RData file for other sources
source_of_interest <- NA
source("vignettes/CaseStudies/01_get_Emission.R")
```

# 02: Make parameter dataframes for tyre wear and other sources and save them as RData files
```{r 02 Make parameter RData files}
# Make parameters file for tyre wear
source_of_interest <- "Tyre wear"
source("vignettes/CaseStudies/02_get_Parameters.R")

# Make emission RData file for other sources
source_of_interest <- NA
source("vignettes/CaseStudies/02_get_Parameters.R")
```

# Visualize the variable distributions for tyre wear

```{r Make some figures to show the values chosen from the distributions}
source_of_interest <- "Tyre wear"
env <- "OOD"

if(env == "Local"){
  if(!is.na(source_of_interest) && source_of_interest == "Tyre wear"){
    #load(paste0("R:/Projecten/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/DPMFAoutput_LEON-T_D3.5_TWP_20241110.RData"))
    load(paste0("R:/Projecten/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/Parameters_LEON-T_D3.5_TWP_20241110.RData"))
  } else if(is.na(source_of_interest)){
    #load(paste0("R:/Projecten/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/DPMFAoutput_LEON-T_D3.5_Other_20241111.RData"))
    load(paste0("R:/Projecten/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/Parameters_LEON-T_D3.5_Other_20241111.RData"))
  }
} else if(env == "OOD"){
  if(!is.na(source_of_interest) && source_of_interest == "Tyre wear"){
    #load(paste0("/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/DPMFAoutput_LEON-T_D3.5_TWP_20241110.RData"))
    load(paste0("/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/Parameters_LEON-T_D3.5_TWP_", format(Sys.Date(),"%Y%m%d"), ".RData"))
  } else if(is.na(source_of_interest)){
    #load(paste0("/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/DPMFAoutput_LEON-T_D3.5_Other_20241111.RData"))
    load(paste0("/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/Parameters_LEON-T_D3.5_Other_", format(Sys.Date(),"%Y%m%d"), ".RData"))
  }
}

Material_Parameters_n <- Parameters$Material_Parameters_n
#Example of plot:
#TODO: include units

PlotVariable = "alpha"
ggplot(Material_Parameters_n |> filter(VarName == PlotVariable) |> unnest(data), aes(x=value,y=SubCompart)) +
  geom_violin()+
  facet_wrap(vars(Polymer,Species))+
  xlab(PlotVariable)

PlotVariable = "RadS"
ggplot(Material_Parameters_n |> filter(VarName == PlotVariable) |> unnest(data), aes(x=value,y=SubCompart)) +
  geom_violin()+
  facet_wrap(vars(Polymer,Source))+
  xlab(paste(PlotVariable)) #+ scale_x_log10() 

PlotVariable = "RhoS"
ggplot(Material_Parameters_n |> filter(VarName == PlotVariable) |> unnest(data), aes(x=value,y=SubCompart)) +
  geom_violin()+
  facet_wrap(vars(Polymer,Source))+
  xlab(paste(PlotVariable)) 

PlotVariable = "kdeg"
ggplot(Material_Parameters_n |> filter(VarName == PlotVariable) |> unnest(data), aes(x=value,y=SubCompart)) +
  geom_violin()+
  facet_wrap(vars(Polymer,Species))+
  xlab(paste(PlotVariable)) 

PlotVariable = "kfrag"
ggplot(Material_Parameters_n |> filter(VarName == PlotVariable) |> unnest(data), aes(x=value,y=SubCompart)) +
  geom_violin()+
  facet_wrap(vars(Polymer,Species))+
  xlab(paste(PlotVariable)) 
```

# Make batch files for the High Performance Cluster
Calculating dynamic masses with uncertainty for 1950 to 2050 with 1000 runs takes too
much computing power to calculate in RStudio. Therefore, a high performance cluster (HPC)
was used to calculate the results. The script sourced below divides the 1000 runs for 
tyre wear and other sources between different 'batch scripts', which can then
be sent separately to the HPC. This significantly lowers the computing time, 
as the results are calculated in parallel and a large number of nodes is 
available. 

The following packages should be installed in the environment of your linux terminal:
- tidyverse

## Make batch scripts for tyre wear
The chunk below creates batch scripts for tyre wear, and a txt files with LSF commands. 
Copy the LSF commands into your linux terminal to run the batch scripts. 
```{r Create batch scripts for tyre wear}
# Define batch parameters for tyre wear
batch_n <- 2
batch_max <- 1000  # Should be a multiple of batch_n for the loop logic to work
Source <- '"Tyre wear"'

source("vignettes/CaseStudies/HPC_batch_files.R")
```

## Make batch scripts for other sources
The chunk below creates batch scripts for other sources, and a txt files with LSF commands. 
Copy the LSF commands into your linux terminal to run the batch scripts. 
```{r Create batch scripts for other sources}
# Define batch parameters for other sources
batch_n <- 2
batch_max <- 1000  # Should be a multiple of batch_n for the loop logic to work
Source <- NA

source("vignettes/CaseStudies/HPC_batch_files.R")
```

# Bind the data
Once the batch scripts have been run, the data can be bound together. This is done
using the a script that binds data in parallel, as this saves time. 

Needed packages : 
- tidyverse
- stringr
- doParallel

```{r 04: Bind data in parallel}
source("vignettes/CaseStudies/04_bind_data_parallel.R")

```
