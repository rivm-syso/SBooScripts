---
title: "LEON-T TWP data analysis"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r HPC output}
## internal output file testing:

HPC_output_path <- "/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/HPC_output"
HPC_SBout_files <- list.files(HPC_output_path)
HPC_SBout_files[501]

load(paste0(HPC_output_path,"/",HPC_SBout_files[502]))

Output
# This output is not expected.

rm(list = objects()[-grep("HPC_",objects())])

# another folder with output
HPC_output_path <- "/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/Output"
HPC_SBout_files <- list.files(HPC_output_path)

load(paste0(HPC_output_path,"/",HPC_SBout_files[501]))

Output

rm(list = objects()[-grep("HPC_",objects())])



```

```{r TWP data}

load(paste0(HPC_output_path,"/",HPC_SBout_files[60]))

Output$SBoutput[1][[1]]$DynamicMass
length(Output$SBoutput[1][[1]]$DynamicMass$time)
plot(Output$SBoutput[1][[1]]$DynamicMass$time,
     Output$SBoutput[1][[1]]$DynamicMass$w1CP)
length(Output$SBoutput[1][[1]]$DynamicConc$Concentrations$time)
plot(Output$SBoutput[1][[1]]$DynamicConc$Concentrations$time,
     Output$SBoutput[1][[1]]$DynamicConc$Concentrations$w1CP) # bij plotten van bijvoorbeeld file 60, ziet de concentratie plot er erg vreemd uit, zou  ook twee stijgende lijnen moeten zijn

pl_emis <- Output$SBoutput[1][[1]]$Input_Emission |> unnest(Emis) |> pivot_wider(names_from = Abbr, values_from = value)
plot(pl_emis$Timed,
     pl_emis$w1RP)


Sel_DPMFA_micro |> 
  unnest(Emis) |> 
  ungroup() |> group_by(Year,Polymer) |> 
  summarise(Emis_kt_year = mean(value)*(3600*24*365.25)/1000000) |> 
  filter(Year < 2020) |> 
  ungroup() |> group_by(Polymer) |> 
  summarise(Emis_kt = sum(Emis_kt_year)) # Emission NR and SBR from 1950 up to 2019 in 1000 ton


mean(as.vector(Material_Parameters_n$data[[1]]$value))

Material_Parameters_n |> distinct(VarName)

MatParAavg <- function(input=Material_Parameters_n$data[[1]]){
  mean(input$value)
}

Material_Parameters_n |> 
  mutate(Average = map_dbl(data, MatParAavg)) |>
  # filter(VarName == "kdeg") |> 
  distinct(nvar,.keep_all = TRUE)

rm(list = objects())

```

```{r DPMFA data}
abspath_EU = "/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/DPMFA_EU.RData"
abspath_NL = "/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/DPMFA_NL.RData" # data file location
source_of_interest = "Tyre wear" # a specific source or NA for all
path_parameters_file = "vignettes/CaseStudies/CaseData/Microplastic_variables_v1.xlsx"
TESTING = F # if set to T, using only first 2 runs.

library(tidyverse)
load(abspath_EU)

# Convert to long format
data_long_EU <- 
  DPMFA_sink |> 
  unnest(Mass_Polymer_kt, keep_empty = TRUE) |> 
  pivot_longer(cols=-c(Type, Scale, Source, Polymer, To_Compartment, Material_Type, iD_source, RUN),
               names_to = "Year",
               values_to = "Mass_Polymer_kt") |>
    rename(Cum_Mass_Polymer_kt = Mass_Polymer_kt) |> 
  mutate(Mass_Polymer_kt = Cum_Mass_Polymer_kt - lag(Cum_Mass_Polymer_kt, default = 0)) |> 
  mutate(Mass_Polymer_kg_s = Mass_Polymer_kt*1000000/(365.25*24*3600)) |> # Convert kt/year to kg/s
  # filter(Material_Type == "micro") |> # Select microplastics only
  mutate(SBscale = ifelse(Scale == "EU", "C", "R")) 

data_long_EU |> 
  filter(Source == "Tyre wear") |> 
  ungroup() |> 
  group_by(RUN,Year) |> 
  summarise(TotEmission_kt = sum(Mass_Polymer_kt)) |> 
  ungroup() |> 
  group_by(Year) |> 
  summarise(Avg_Emis_kt = mean(TotEmission_kt),
            min_Emis_kt = min(TotEmission_kt),
            max_Emis_kt = max(TotEmission_kt)) |> 
  filter(Year == 2019)
# the result is way too much emission.

data_long_EU |> distinct(Source)
data_long_EU |> 
  filter(Source == "Domestic primary plastic production") |> 
  ungroup() |> 
  group_by(RUN,Year) |> 
  summarise(TotEmission_kt = sum(Mass_Polymer_kt)) |> 
  ungroup() |> 
  group_by(Year) |> 
  summarise(Avg_Emis_kt = mean(TotEmission_kt),
            min_Emis_kt = min(TotEmission_kt),
            max_Emis_kt = max(TotEmission_kt)) |> 
  filter(Year == 2019)

abspath_EU_test <-  "/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/DPMFA_data_EU2024_11_26.RData"

load(abspath_EU_test)

# Convert to long format
data_long_EU_test <- 
  DPMFA_sink |> unnest(Mass_Polymer_kt, keep_empty = TRUE) |> 
  pivot_longer(cols=-c(Type, Scale, Source, Polymer, To_Compartment, Material_Type, iD_source, RUN),
               names_to = "Year",
               values_to = "Mass_Polymer_kt") |>
  mutate(Mass_Polymer_kg_s = Mass_Polymer_kt*1000000/(365.25*24*3600)) |> # Convert kt/year to kg/s
  # filter(Material_Type == "micro") |> # Select microplastics only
  mutate(SBscale = ifelse(Scale == "EU", "C", "R")) 

data_long_EU_test_TW <- data_long_EU_test|> 
  filter(Source == "Tyre wear") |> 
  ungroup() |> 
  group_by(RUN,Year) |> 
  summarise(TotEmission_kt = sum(Mass_Polymer_kt)) |> 
  ungroup() |> 
  group_by(Year) |> 
  summarise(Avg_Emis_kt = mean(TotEmission_kt),
            min_Emis_kt = min(TotEmission_kt),
            max_Emis_kt = max(TotEmission_kt)) |> 
  filter(Year == 2019)

data_long_EU |> distinct(Source)
data_long_EU |> 
  filter(Source == "Domestic primary plastic production") |> 
  ungroup() |> 
  group_by(RUN,Year) |> 
  summarise(TotEmission_kt = sum(Mass_Polymer_kt)) |> 
  ungroup() |> 
  group_by(Year) |> 
  summarise(Avg_Emis_kt = mean(TotEmission_kt),
            min_Emis_kt = min(TotEmission_kt),
            max_Emis_kt = max(TotEmission_kt)) |> 
  filter(Year == 2019)


rm(list = objects()[-grep("HPC_",objects())])
```

```{r Test with DPMFA_inflow instead of DPMFA_sink}
abspath_EU_test <-  "/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/DPMFA_data_EU2024_11_26.RData"
load(abspath_EU_test)

######## Use DPMFA inflow instead of sinks, because DPMFA_sink is cumulative over years ######
sinks <- unique(DPMFA_sink$To_Compartment)

# Convert to long format
data_long_EU_test <- DPMFA_inflow|>
  filter(To_Compartment %in% sinks) |>
  unnest(Mass_Polymer_kt, keep_empty = TRUE) |> 
  pivot_longer(cols=-c(Type, Scale, Source, Polymer, To_Compartment, Material_Type, iD_source, RUN),
               names_to = "Year",
               values_to = "Mass_Polymer_kt") |>
  mutate(Mass_Polymer_kg_s = Mass_Polymer_kt*1000000/(365.25*24*3600)) |> # Convert kt/year to kg/s
  # filter(Material_Type == "micro") |> # Select microplastics only
  mutate(SBscale = ifelse(Scale == "EU", "C", "R")) 

data_long_EU_test_TW <- data_long_EU_test|> 
  filter(Source == "Tyre wear") |> 
  ungroup() |> 
  group_by(RUN,Year) |> 
  summarise(TotEmission_kt = sum(Mass_Polymer_kt)) |> 
  ungroup() |> 
  group_by(Year) |> 
  summarise(Avg_Emis_kt = mean(TotEmission_kt),
            min_Emis_kt = min(TotEmission_kt),
            max_Emis_kt = max(TotEmission_kt)) |> 
  filter(Year == 2019)

####### Test with all data ##########

# TO DO: Add test with all DPMFA_EU data, using DPMFA_sink 
```

```{r Material parameters}
load(paste0("/rivm/r/E121554 LEON-T/03 - uitvoering WP3/Deliverable 3.5/DPMFAoutput_LEON-T_D3.5_TWP_20241110.RData"))
Material_Parameters_n <- Parameters$Material_Parameters_n
Material_Parameters_long <- Material_Parameters_n |>
  rowwise() |>
  mutate(data = list(data |> mutate(RUN = row_number()))) |>
  ungroup() |>
  unnest(data)

source("vignettes/CaseStudies/f_plot_functions.R")

```






