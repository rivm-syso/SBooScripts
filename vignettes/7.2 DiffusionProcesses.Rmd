---
title: "DiffusionProcesses"
author: "JS"
date: "2023-08-03"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
knitr::knit_meta()
# knitr::opts_chunk$set(echo = TRUE)
projectRoot <- paste(getwd(), "..", sep = "/")
knitr::opts_knit$set(root.dir = projectRoot) #assuming vignette is in a direct subfolder of the project
```

# INTERMEDIA TRANSFER

The intermedia transfer processes are related to transport from air to soil/water and from water to sediment, and vice versa. Also transport from soil to water.

## Intro

We initialise a "World" and calculate the needed parameters.

```{r initiate, echo=TRUE, message=FALSE, warning=TRUE}
#we initialize the test environment with the default substance, therefor we remove possible earlier value
rm(substance)
# substance <- "organic acid"
#script to initialize test environment, including faking a future 'library(sboo)'
try(source("baseScripts/initTestWorld.R"))
#calculation of the needed SB variables, first compiling their defining functions

# non variable input data which is calculated (see partioning.Rmd) needs to be available before you can proceed

# This needs to be calculated first:
World$NewCalcVariable("FRorig")
World$CalcVar("FRorig")
World$NewCalcVariable("FRorig_spw")
World$CalcVar("FRorig_spw")

# World$NewCalcVariable("FRACa")
World$fetchData("FRACa")
# World$NewCalcVariable("FRACw")
World$fetchData("FRACw")

World$NewCalcVariable("FRACs")
World$CalcVar("FRACs")

# World$fetchData("FRACs")
# World$fetchData()

# debugonce(f_Ksw)

KswModelled <- f_Ksw(Kow = World$fetchData("Kow"), 
                    pKa = 7, 
                    CorgStandard = World$fetchData("CorgStandard"), 
                    a = with(World$fetchData("QSARtable"), 
                             a[QSAR.ChemClass == World$fetchData("ChemClass")]), 
                    b = with(World$fetchData("QSARtable"), 
                             b[QSAR.ChemClass == World$fetchData("ChemClass")]), 
                    ChemClass = World$fetchData("ChemClass"),
                    RHOsolid = with(World$fetchData("rhoMatrix"),
                                    rhoMatrix[SubCompart == "othersoil"]),
                    alt_form = F)

Ksw.alt <- f_Ksw(Kow = World$fetchData("Kow"), 
                    pKa = 7, 
                    CorgStandard = World$fetchData("CorgStandard"), 
                    a = with(World$fetchData("QSARtable"), 
                             a[QSAR.ChemClass == World$fetchData("ChemClass")]), 
                    b = with(World$fetchData("QSARtable"), 
                             b[QSAR.ChemClass == World$fetchData("ChemClass")]), 
                    ChemClass = World$fetchData("ChemClass"),
                    RHOsolid = with(World$fetchData("rhoMatrix"),
                                    rhoMatrix[SubCompart == "othersoil"]),
                    alt_form = T, KswModelled)

FromData <- World$fetchData("Globals")
FromData$Ksw <- KswModelled
FromData$Ksw.alt <- Ksw.alt
FromData$RHOsolid <- with(World$fetchData("rhoMatrix"),
                                    rhoMatrix[SubCompart == "othersoil"])
World$UpdateData(FromData, keys = T, TableName = "Globals")

# source("/rivm/s/quikj/SimpleBox_dev/sbooScripts/newAlgorithmScripts/f_kdegcalc.R")
kdeg.sediment <- kdegcalc(Q.10 = World$fetchData("Q.10"), 
                          Ksw = World$fetchData("Ksw"), 
                          Biodeg = "r", 
                          C.OHrad.n = World$fetchData("C.OHrad.n"), 
                          Ea.OHrad = World$fetchData("Ea.OHrad"), 
                          k0.OHrad = World$fetchData("k0.OHrad"),
                          CorgStandard = World$fetchData("CorgStandard"), 
                          RHOsolid = World$fetchData("RHOsolid"),
                          Matrix = "sediment")
FromData <- World$fetchData("Globals")
FromData$kdeg.sediment <- kdeg.sediment
World$UpdateData(FromData, keys = T, TableName = "Globals")

World$NewCalcVariable("Kp")
World$CalcVar("Kp")

World$NewCalcVariable("D")
World$CalcVar("D")
World$NewCalcVariable("KpCOL")
World$CalcVar("KpCOL")

World$NewCalcVariable("Kacompw")
World$CalcVar("Kacompw")

World$NewCalcVariable("FRinw")
World$CalcVar("FRinw")

World$NewCalcVariable("Kaerw")
World$CalcVar("Kaerw")
World$NewCalcVariable("Kaers")
World$CalcVar("Kaers")

World$NewCalcVariable("FRingas")
World$CalcVar("FRingas")

```

## Partial Mass Transfer Coefficient's (MTC)

Diffusion governs the Volatisation and desorption processes. These are modelled following the classic two-film theory [REF]. The equilibria constants between the media are important parameters. Their calculation is described in the vignette partitioning [`link`].

Partial Mass Transfer Coefficients operate like resistors; to calculate the total MTC we use 1/K = 1/k1 + 1/(kp.k2), with kp the equilibrium constant. The soil side MTCa,s is related to the degradation of the substance, for water/air the wind plays a role. The defining functions are organised by the medium the film is bordering towards, but use the properties of the medium () of the box) they are defined for, the departure of the diffusion.

Following is the implementation of 4 MTC's.

1.  MTC_2a -\> for water side of the water-air interface (from water to air) and the soil side of the soil-air interface (from soil to air).

2.  MTC_2w -\> for air side of the air-water interface (from air to water) and the sediment side of the sediment-water interface (from sediment to water).

3.  MTC_2s -\> for the air side of the air-soil interface (from air to soil).

4.  MTC_2sd -\> for the water side of the water-sediment interface (from water to sediment).

```{r MTC}
# MTCvars <- c("MTC_2a", "MTC_2w", "MTC_2s", "MTC_2sd")
# for (x in MTCvars) {
#   source(paste0("newAlgorithmScripts/v_", x ,".R"))
# }

World$NewCalcVariable("MTC_2a")
World$CalcVar("MTC_2a")
World$NewCalcVariable("MTC_2w")
World$CalcVar("MTC_2w")
World$NewCalcVariable("MTC_2s")
World$CalcVar("MTC_2s")
World$NewCalcVariable("MTC_2sd")
World$CalcVar("MTC_2sd")

World$NewCalcVariable("Kscompw")
World$CalcVar("Kscompw")
```


## Adsorption
Adsoprtion is implemented to estimate the flux of chemical from air to soil and water, and from water to sediment.
documentation needed

```{r}

World$FromDataAndTo("k_Adsorption")
testProc <- World$NewProcess("k_Adsorption")
testProc$execute()
World$fetchData("FRorig_spw")


# Kscompw 
World$NewProcess("k_Adsorption")
World$UpdateKaas("k_Adsorption")
World$FromDataAndTo("k_Adsorption")

# (FRingas, FRinw, MTC_2sd, MTC_2w, MTC_2a, MTC_2s, FRorig, Kacompw, Kscompw, to.Matrix, VertDistance, landFRAC)


World$fetchData("kwsd.water")
World$fetchData("kwsd.sed")
World$fetchData("FRingas")
World$fetchData("FRinw")
World$fetchData("MTC_2sd")
World$fetchData("MTC_2w")
# all.MTC_2w <- World$fetchData("MTC_2w")
# to.SubCompart = "freshwatersediment"
# to.MTC_2w <- all.MTC_2w$MTC_2w[all.MTC_2w$SubCompart == to.SubCompart]

World$fetchData("MTC_2a")
World$fetchData("MTC_2s")
World$fetchData("FRorig")

World$fetchData("FRorig")
World$fetchData("Kacompw")
World$fetchData("Kscompw")
World$fetchData("Matrix")
World$fetchData("VertDistance")
World$fetchData("landFRAC")
World$fetchData("SpeciesName")
                # , "FRinw", "MTC_2sd", "MTC_2w", "MTC_2a", "MTC_2s", "FRorig", "Kacompw", "Kscompw", "to.Matrix", "VertDistance", "landFRAC")

# testClass <- World$NewProcess("k_Adsorption")
# testClass$execute(DebugAt = list())
# 
# debugonce(testClass$execute)
# testClass$execute(DebugAt = list())


```

## Volatilisation and desorption

Volatilisaation is implemented for the flux from soil or water to air for molecular chemicals in k_Volatilisation.
Desorption is implemented for the flux from sediment to water for molecular chemicals in k_Desorption.

For Volatilisation and some other processes affecting the soil, a correction factor is calculated. The correction factor for depth dependent soil concentration can be obtained from Hollander et al. (2004). Here this is implemented in a function: `r f_CORRsoil`.

```{r}

source("newAlgorithmScripts/k_Volatilisation.R")
source("newAlgorithmScripts/f_CORRsoil.R")
World$fetchData("penetration_depth_s") 

World$FromDataAndTo("k_Volatilisation")
testProc <- World$NewProcess("k_Volatilisation")
testProc$execute()

World$NewCalcVariable("Ksdcompw")
World$CalcVar("Ksdcompw")

source("newAlgorithmScripts/k_Desorption.R")

# World$NewCalcVariable("k_Desorption")
# World$CalcVar("k_Desorption")

```

## Other relevant intermedia transfer processes
In addition to the processes governed by diffusion, the following intermedia processes are implemented:
- k_Resuspension
- k_Deposition
- k_Erosion
- k_Runoff


```{r}
# In the end we need to order csv's and upate unit.csv

source("baseScripts/ReorderCSV.R")



AllVarnames <- World$fetchData() 
#There should be 1 place (table) for a variable; are there multiple?
table(AllVarnames)[table(AllVarnames)!=1]
#Columns of the QSAR table are an exception, can be ignored here...
#Also ignore variable-names starting with k_. The are the exceptions to the described process from-and-to data
#Also ignore variable starting with Abbr, these are for old (excel) variable naming convention
#Also ignore "Waarde", "Dimension", "forWhich" and "unit", other technicalities...
AllVarnames <- AllVarnames[!startsWith(AllVarnames, prefix = "k_") & 
                             !startsWith(AllVarnames, prefix = "Abbr") &
                             !startsWith(AllVarnames, prefix = "outdated")]
AllVarnames <- AllVarnames[!AllVarnames %in% c("VarName", "Waarde", "Dimension", "forWhich", "Unit", "table")] 
#compare to the units table; which has been read into the World by 
UnitTable <- NewstateModule$SB4N.data[["Units"]]

unique(AllVarnames)[!AllVarnames %in% UnitTable$VarName]

UnitTable$VarName[!UnitTable$VarName %in% unique(AllVarnames)]


#The trail of variables is stored when reading it originally; in 
NewUnits <- left_join(UnitTable, NewstateModule$varOrigine)
AlfOrder <- order(NewUnits$VarName)
# write.csv(NewUnits[AlfOrder,], file = "data/Units.csv")
# source("baseScripts/ReorderCSV.R") not needed because already alphabetic

```
