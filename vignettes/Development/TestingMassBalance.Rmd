---
title: "Testing Mass Balance"
author: "Valerie de Rijk"
date: "`r Sys.Date()`"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::knit_meta()
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
projectRoot <- paste(getwd(), "..", "..", sep = "/")
knitr::opts_knit$set(root.dir = projectRoot) 
```

## Initiation

We assume you have the input data for a substance or material of interest and all the data describing the SimpleBox world to be created ready and thus can run the initWorld script.

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
library(dplyr)
source("baseScripts/initWorld_onlyParticulate.R")
World$NewSolver("SB1Solve")

```

```{r solver}

file_paths <- 
  list.files("data/emissions",recursive = TRUE)
Emissions <-
  read_csv(paste0("data/emissions/",file_paths), id="file_name", col_names = c("RUN",0:24),skip = 1)

Emissions <- 
  Emissions |>
  pivot_longer(
    cols = !c(file_name,RUN),
    names_to = "year",
    values_to = "emission_t" ) |> mutate_at('year',as.numeric) |> 
  ungroup() |> 
  group_by(file_name,year) |> 
  summarise(Emission_p50_kg = quantile(emission_t,probs = 0.5),
            Emission_mean = mean(emission_t)) |> ungroup()

Emissions <- 
  Emissions |> 
  mutate(compartment = 
           case_when(str_detect(file_name, "(?i)Air") ~ "Air",
                     str_detect(file_name, "(?i)Soil") ~ "SludgeTreatedSoil",
                     str_detect(file_name, "(?i)Water") ~ "SurfaceWater",
                     str_detect(file_name, "(?i)Subsurface") ~ "Subsurface",
                     TRUE ~ "Other"),
         scale = 
           case_when(str_detect(file_name, "(?i)EU") ~ "EU_average",
                     str_detect(file_name, "(?i)Ireland") ~ "EU_STsoil",
                     str_detect(file_name, "(?i)Switzerland") ~ "EU_noSTsoil",
                     TRUE ~ "Other"),
         Substance = "GO-Chitosan",
  )
Emissions <- 
  Emissions |> 
  mutate(compartment = 
           case_when(str_detect(file_name, "(?i)Air") ~ "Air",
                     str_detect(file_name, "(?i)Soil") ~ "SludgeTreatedSoil",
                     str_detect(file_name, "(?i)Water") ~ "SurfaceWater",
                     str_detect(file_name, "(?i)Subsurface") ~ "Subsurface",
                     TRUE ~ "Other"),
         scale = 
           case_when(str_detect(file_name, "(?i)EU") ~ "EU_average",
                     str_detect(file_name, "(?i)Ireland") ~ "EU_STsoil",
                     str_detect(file_name, "(?i)Switzerland") ~ "EU_noSTsoil",
                     TRUE ~ "Other"),
         Substance = "GO-Chitosan",
  )

Emissions <- Emissions |>
  filter(compartment == "SurfaceWater" & scale == "EU_average") |> 
  select(everything())


plot(Emissions$year, Emissions$Emission_mean, 
     type = "l",  # "l" for line plot, or use "p" for points
     xlab = "Time", ylab = "Emission_mean_tonnes",
     main = "Emission Mean over Time")

Emissions <- Emissions |>
  mutate(Abr = "w1CS")
Emissions_avg <- Emissions[-nrow(Emissions), ]

average_emission <- mean(Emissions_avg$Emission_mean[7:23], na.rm = TRUE)
print(average_emission)
emissions <- data.frame(Abbr = "w1CS", 
                        Emis = average_emission)
emissions$Emis<- emissions$Emis * 1000 / (365.25 * 24 * 60 * 60) # convert 1 t/y to si units: kg/s
```

```{r Solving}
SolutionSteady <- World$Solve(emissions)
SolutionSteady <- SolutionSteady |>
  filter(Species != "Unbound")

```


```{r Mass Balance Check}
unique_combinations <- SolutionSteady |>
  select(Scale, SubCompart, Species) |>
  distinct()
emission_rows <- unique_combinations |>
  mutate(
    Value = "emission",
    EqMass = if_else(Scale == "Continental" & SubCompart == "river" & Species == "Solid", emissions$Emis, 0)
  )

#adding "from" and "to" acronyms to the R K matrix
kaas <- as_tibble(World$kaas)
kaas <- kaas |>
  filter(fromSpecies != "Unbound")
kaas <- kaas |>
  left_join(SolutionSteady, by = c("fromScale" = "Scale", "fromSubCompart" = "SubCompart", "fromSpecies" = "Species"))

# Multiply k by the corresponding EqMass
kaas <- kaas |>
  mutate(k = k * EqMass)
kaas <- kaas |>
  mutate(k = if_else(fromSubCompart == toSubCompart &
                       fromScale == toScale &
                       fromSpecies == toSpecies,
                     -abs(k),
                     k))
print(kaas)
unique(kaas$fromScale)
unique(kaas$fromSubCompart)
print(kaas)

aggregated_to <- kaas |>
  group_by(toScale, toSubCompart, toSpecies) |>
  summarise(k_sum_to = sum(k)) |> 
  ungroup()

# Aggregate k values based on fromScale, fromSubCompart, and fromSpecies
aggregated_from <- kaas |>
  filter(k>=0) |>
  group_by(fromScale, fromSubCompart, fromSpecies) |>
  summarise(k_sum_from = sum(k)) |>
  ungroup()

new_rows_from <- aggregated_from |>
  mutate(
    Value = paste("transportfrom"),
    Scale = fromScale,
    SubCompart = fromSubCompart,
    Species = fromSpecies,
    EqMass = k_sum_from
  ) |>
  select(Value, Scale, SubCompart, Species, EqMass)

new_rows_to <- aggregated_to |>
  mutate(
    Value= paste("transportto"),
    Scale = toScale,
    SubCompart = toSubCompart,
    Species = toSpecies,
    EqMass = k_sum_to
  ) |>
  select(Value, Scale, SubCompart, Species, EqMass)

# Combine SolutionSteady with new rows
massbalancecheck <- bind_rows(new_rows_from, new_rows_to, emission_rows)
print(massbalancecheck)

massbalancecheck_sorted <- massbalancecheck |>
  arrange(Scale, SubCompart, Species)

massbalance_difference <- massbalancecheck_sorted |>
  pivot_wider(names_from = Value, values_from = EqMass) |>
  mutate(difference = transportto + emission - transportfrom ) |>
  select(Scale, SubCompart, Species, difference) 

print(massbalance_difference)

total_abs_difference <- sum(abs(massbalance_difference$difference), na.rm = TRUE)
print(total_abs_difference)

# Find the row with the largest value in the EqMass column
max_row_index <- which.max(massbalance_difference$difference)
max_row <- massbalance_difference[max_row_index, ]

# Print the row with the largest EqMass value
print(max_row)   
```