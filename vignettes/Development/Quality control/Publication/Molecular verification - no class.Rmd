---
title: "Molecular verification - no class"
author: "Anne Hids"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::knit_meta()
knitr::opts_chunk$set(echo = TRUE)
projectRoot <- paste(getwd(), "..", "..", "..", "..", sep = "/")
knitr::opts_knit$set(root.dir = projectRoot) #assuming vignette is in a direct subfolder of the project
options(dplyr.summarise.inform=FALSE)
knitr::opts_chunk$set(echo = TRUE, fig.width = 14, fig.height = 8)
```

*This vignettes demonstrates the verification process of the molecular
version of Simplebox. First, the k's are compared between R and excel,
and consequently the steady state masses are compared. This is done for
5 molecular substances; each of a different chemical class (no class,
acid, base, neutral and metal). The reason that the verification is performed for 
each of these classes is that some processes differ per class.*

First, the world needs to be initialized for a substance. In this case, that substance
is 1-aminoanthraquinone, which does not have a class. 

```{r Initialize,include=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
# Create a list with the names of substances
Potential_substances <- c("1-aminoanthraquinone", # no class
                          "1-HYDROXYANTHRAQUINONE", # acid
                          "1-Hexadecanamine, N,N-dimethyl-", # base
                          "1-Chloro-2-nitro-propane", # neutral
                          "Sb(III)" # metal
                          ) 
              
substance <- Potential_substances[1]

source("baseScripts/initWorld_onlyMolec.R")
```

```{r data xlsx and R, echo=FALSE, warning=FALSE}
#Comparing K's from R model to K's from excel model
library(openxlsx)
library(tidyverse)

ProcessMolFunctions <- c("k_Adsorption", "k_Advection", "k_Burial",
                          "k_Degradation", "k_Deposition", "k_Desorption",
                          "k_Erosion", "k_Escape", 
                         "k_Leaching", "k_Resuspension", "k_Runoff", "k_Sedimentation", 
                         "k_Volatilisation")

#read in K matrix from excel
SBExcelName <- paste0("vignettes/Development/Quality control/SBExcel/SimpleBox4.04_20240723_",substance,".xlsm") 

SBexcel.K <- read.xlsx(SBExcelName,
                  colNames = FALSE,
                  namedRegion = "K")
SBexcel.Names <- read.xlsx(SBExcelName,
                  colNames = FALSE,
                  namedRegion = "box_names")

colnames(SBexcel.K) <- SBexcel.Names
SBexcel.K$to <-  as.character(SBexcel.Names)

SBexcel.K <- pivot_longer(SBexcel.K, cols =  as.character(SBexcel.Names), values_to = "k", names_to = "from")

#adding "from" and "to" acronyms to the R K matrix
kaas <- as_tibble(World$kaas)

#R version does not us the acronyms of the excel version, set-up to convert them
#Note: this map creates the wrong acronym for soil and sediment at global scale, this is fixed afterwards
accronym_map <- c("marinesediment" = "sd2",
                "freshwatersediment" = "sd1",
                "lakesediment" = "sd0", 
                "agriculturalsoil" = "s2",
                "naturalsoil" = "s1",
                "othersoil" = "s3",
                "air" = "a",
                "deepocean" = "w3",
                "sea" = "w2",
                "river" = "w1",
                "lake" = "w0")

accronym_map2 <- c("Arctic" = "A",
                   "Moderate" = "M",
                   "Tropic" = "T",
                   "Continental" = "C",
                   "Regional" = "R")

kaas <- kaas |> mutate(from =  paste0(accronym_map[fromSubCompart], 
                            accronym_map2[fromScale]),
               to = paste0(accronym_map[toSubCompart], 
                           accronym_map2[toScale]))

# Issue that compartments sediment and soil at global scale in excel have sd and s as acronyms instead of sd2 and s1
kaas <- 
  kaas |> 
  mutate(from = 
                   ifelse((fromScale == "Tropic" | fromScale == "Arctic" | fromScale == "Moderate") & 
                            (fromSubCompart == "marinesediment" | fromSubCompart == "naturalsoil"), 
                          str_replace_all(from, c("sd2"="sd","s1"="s")), 
                          from)) |> 
  mutate(to = ifelse((toScale == "Tropic" | toScale == "Arctic" | toScale == "Moderate") & 
                       (toSubCompart == "marinesediment" | toSubCompart == "naturalsoil"), str_replace_all(to, c("sd2"="sd","s1"="s")), to))

kaas2 <- kaas |>  
  filter(from != to) |> #filtering the diagonals ou
  group_by(from, to) %>% summarize(k = sum(k)) #R version sometimes has multiple k's per fromto box; excel only has the summed k's per box

kaas2$fromto <- paste(sep = "_", kaas2$from, kaas2$to)

diagonal_excel <- SBexcel.K[SBexcel.K$from == SBexcel.K$to,] #all the diagonals in excel are negative values -> sums of all the "froms" of that compartment

diagonal_R <- 
  aggregate(k ~ from, data = kaas, FUN = sum) #R model has k values per process, not per box. For the "diagonal" ("from = to") boxes, this is different than in the excel version. summing all the "froms" here to be able to compare them with excel matrix. This should result in one value for each compartment (scale-subcomp-species combo)

#Single dataframe with both the R and excel diagonals
merged_diagonal <- merge(diagonal_R, diagonal_excel, by = "from", suffixes = c("_R", "_Excel")) 
merged_diagonal$k_Excel <- -merged_diagonal$k_Excel #Turning the "negative" values from the Excel matrix into positive ones
merged_diagonal$diff <- merged_diagonal$k_R - merged_diagonal$k_Excel 
merged_diagonal$reldif <- merged_diagonal$diff/merged_diagonal$k_R

SBexcel.K <- filter(SBexcel.K, k != 0 & SBexcel.K$from != SBexcel.K$to)
SBexcel.K$fromto <- paste(sep = "_", SBexcel.K$from, SBexcel.K$to)

mergedkaas <- merge(kaas2, SBexcel.K, by = c("from", "to"), suffixes = c("_R", "_Excel"))

mergedkaas$diff <- mergedkaas$k_R - mergedkaas$k_Excel #compare R k to Excel K

mergedkaas <- as_tibble(mergedkaas) |> mutate(relDif = diff/k_R)  


```

## Comparing k's
When comparing k's between R and excel, the goal is that the difference is less
than 1 percentile for each k. The reason is that smaller differences often are 
a result of differences in rounding values between excel and R, and not the result
of mistakes in calculations or different input values. In this vignette two types of 
k's are compared: diagonal k's and from-to k's.

At the time of this verification, some improvements were already made in the R 
version versus the excel version. This meant that some k's differ between R and
excel, but not because the calculations or input values are wrong. In order to 
still be able to compare the two versions, the 'Test' variable was created. This
variable is a boolean, that can be used to calculate some processes in R the same 
way as in excel for the verification, without removing the improvements that are 
made. When this test variable was used and why will be explained below. 

### Diagonal k's
Diagonal k's are k's that are on the diagonal of the k matrix, which means they go
from and to the same compartment. In other words, these k's signify the removal
of the substance from the subcompartment. Processes that can be involved in the 
diagonal k's can i.e. be degradation, leaching or escape.

```{r Plot diagonal differences, echo=FALSE, warning=FALSE}
#Plot of differences of the diagonals per compartment
# Plot of differences of the diagonals per compartment
ggplot(merged_diagonal, aes(x = from, y = diff)) +
  geom_boxplot() +
  ggtitle(paste0("Absolute differences removal k's between R and excel for ", substance)) +
  geom_hline(yintercept = 0.001, color = "red") +
  geom_hline(yintercept = -0.001, color = "red") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Rotate and adjust text size
    plot.margin = margin(t = 10, r = 10, b = 30, l = 10) # Increase bottom margin
  ) +
  labs(x = "from", y = "Absolute diff")

# Plot of relative differences of the diagonals per compartment
ggplot(merged_diagonal, aes(x = from, y = reldif)) +
  geom_boxplot() +
  ggtitle(paste0("Relative differences removal k's between R and excel for ", substance)) +
  geom_hline(yintercept = 0.001, color = "red") +
  geom_hline(yintercept = -0.001, color = "red") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Rotate and adjust text size
    plot.margin = margin(t = 10, r = 10, b = 30, l = 10) # Increase bottom margin
  ) +
  labs(x = "from", y = "Relative diff")
```

Figures 1 and 2 above show the absolute and relative differences in diagonal k's between R and excel. 
As can be seen in Figure 2, relative differences larger than 1 percentile are in the lake and
sediment subcompartments (Table 1). 

```{r filter large diagonal differences, include=TRUE, echo=FALSE}

diagonal_diffs <- merged_diagonal |>
  mutate(reldif = abs(reldif)) |>
  filter(reldif > 0.001) |>
  arrange(desc(reldif))

print(diagonal_diffs)

```

#### Lake difference

The relative difference in lake removal rate is caused by lake sedimentation
being included in R but not in excel. To make an accurate comparison between R 
and excel, the test variable was used to exclude flows to lake sediment in 
k_Sedimentation and k_Adsorption.

```{r Lake removal KEEP FOR FINAL VERSION!}
lake <- kaas |>
  filter(fromSubCompart == "lake") |>
  filter(toSubCompart == "lake")

lake2 <- kaas |>
  filter(fromSubCompart == "lake") |>
  filter(fromScale == "Continental")

```

```{r Soil/air/sediment removal + volatilisation when kdeg is given as input value KEEP FOR FINAL VERSION!}
soil <- kaas |>
  filter(fromSubCompart == "agriculturalsoil") |>
  filter(toSubCompart == "agriculturalsoil") |>
  filter(fromScale == "Continental")

# If there is a slight difference in diagonal k's between excel and R, the difference 
# is caused by the input kdegs. If there are input kdegs for air/soil/sediment 
# (so they are not calculated using KdegDorC), these values have two decimals in R
# but more decimals in excel. This can cause relative differences between the k's
# that are slightly larger than the treshold value of 0.001. 

# This was tested by using the rounded kdeg value as input in excel and comparing
# the resulting k manually to the k in R. 

```

### From-to k's

```{r Plot k differences, echo=FALSE, warning=FALSE}
# "To" and "from" in one plot
ggplot(mergedkaas, aes(x = to, y = from, color = abs(diff))) + 
  geom_point() +
  scale_color_gradient(low = "green", high = "red", trans = "log10") +
  ggtitle(paste0("Absolute differences k's between R and excel for ", substance)) 

ggplot(mergedkaas, aes(x = to, y = from, color = abs(relDif))) + 
  geom_point() +
  scale_color_gradient(low = "green", high = "red") +
  ggtitle(paste0("Relative differences k's between R and excel for ", substance)) 
```

```{r filter large differences, include=TRUE, echo=FALSE}
large_differences <- mergedkaas |>
  mutate(relDif = abs(relDif)) |>
  filter(relDif > 0.001) |>
  arrange(desc(reldif))

print(large_differences)

```

As can be seen in Figure 4 above, the largest relative differences in k's go from 
freshwater and seawater to sediment and back. 





```{r diff aR/aC > s2/s3 KEEP FOR FINAL VERSION!!!}

# Get the kaas from soil to air and see what processes are involved
airsoil <- kaas |>
  filter(fromScale == "Regional") |>
  filter(toSubCompart == "agriculturalsoil" | fromSubCompart == "othersoil") |>
  filter(fromSubCompart == "air")

# To calculate the Gasabs from air to soil, FRorig_spw for natural soil (and freshwater) was used also for other and agricultural soil (and seawater) 
# in excel. 
# In R however, the gasabs is calculated using the FRorig_spw for each specific soil type. By using the 'Test' variable, it was
# possible to temporarly change the FRorig_spw and FRorig in R to the value used in Excel. This fixed the large relative difference for this
# flux between excel and R. Conclusion: GASABS (used to calculate k_Adsorption) in R is calculated specifically for each 
# subcompartment, while in excel this variable is only calculated once for soil and once for water.  


```

```{r sedimentation to water KEEP FOR FINAL VERSION}
resus <- kaas |>
  filter(from == "sd2C") |>
  filter(to == "w2C") 

# The processes involved are resuspension and desorption.

# Get the vertical distance of marinesediment at continental scale
VD <- World$fetchData("VertDistance") |>
  filter(Scale == "Continental") |>
  filter(SubCompart == "marinesediment")

# Multiply the kaas by VD to be able to compare them to excel
resus <- resus |>
  mutate(mult_kaas = k*VD$VertDistance)

# Desorption is more or less the same in excel as in R, there is a larger difference in resuspension. 

# There was a mistake in Excel: Netsedrate for continental seawater was set to 0, while this should have been 2.74*10^-11


# The Kacompw differs slightly from the kacompw in excel

#World$moduleList[["k_Desorption"]]$execute(debugAt = list())

```

```{r Advection regional sea to continental sea}

# The advection differences between R and Excel were caused by different TotalArea in excel than R for the regional and continental scales. It looked like the values in ScaleSheet.csv were rounded, while the values in R were not. This problem was solved by changing the TotalArea values in ScaleSheet.csv to the values used in Excel and Hollander et al. (2015).

```

```{r water to sediment KEEP FOR FINAL VERSION}
# Get kaas from water to sediment

w2s <- kaas |>
  filter(from == "w1C") |>
  filter(to == "sd1C")

# Get the vertical distance of marinesediment at continental scale
VD <- World$fetchData("VertDistance") |>
  filter(Scale == "Continental") |>
  filter(SubCompart == "freshwatersediment")

# Multiply the kaas by VD to be able to compare them to excel
w2s <- w2s |>
  mutate(mult_kaas = k*VD$VertDistance)

# The reason that the k's from w to sd are not the same in R as in excel is that the settling velocities are different, 
# because of a difference in calculation. In excel, the settling velocity is calculated as 2.5/(24*3600). In R, the 
# settling velocity is calculated using a function. 

# By using the test variable it was possible to temporarily use the same function for settling velocity in R as in excel. This
# solved the differences. 

```

```{r air to lake}

# Get the kaas from air to lake

tolake <- kaas |>
  filter(fromSubCompart == "air") |>
  filter(toSubCompart == "lake") |>
  filter(fromScale == "Continental")

# Processes involved are adsorption and deposition

# Convert the k values in R so that they are the same as in Excel for comparison

# Get the areafrac lake
land <- World$fetchData("AreaLand") |>
  filter(Scale == "Continental")

sea <- World$fetchData("AreaSea") |>
  filter(Scale == "Continental")

area <- World$fetchData("Area") |>
  filter(Scale == "Continental") |>
  filter(SubCompart == "lake")

AreaFRAClake <- area$Area/(land$AreaLand+sea$AreaSea)

tolake <- tolake |>
  mutate(k_e = k/AreaFRAClake)

# k_Adsorption is exactly the same in R as in Excel, k_Deposition is slightly different

#World$moduleList[["Kaerw"]]$execute(debugAt = list())

```

```{r comparison of steady state emissions using SB1Solve}

library(stringi)

World$NewSolver("SB1Solve")

emissions <- data.frame(Abbr = c("aRU", "s2RU", "w1RU"), Emis = c(10000, 10000, 10000) ) # convert 1 t/y to si units: kg/s

MW <- World$fetchData("MW")

emissions <- emissions |>
  mutate(Emis = Emis*1000/(MW*365*24*60*60))

SSsolve.R <- World$Solve(emissions)

SSsolve.excel <- read.xlsx(SBExcelName,
                             sheet=11,
                             colNames=TRUE,
                             rows=c(44,45))

SSsolve.excel <- SSsolve.excel |>
  select(-c(STEADY.STATE, X2)) |>
  pivot_longer(names_to = "Abbr", values_to = "EqMass", cols = everything()) 

SSsolve.R <- SSsolve.R |> mutate(Abbr =  paste0(accronym_map[SubCompart], 
                            accronym_map2[Scale])) |>
  mutate(SubCompart = str_replace(SubCompart, "lakesediment", "lake")) |>
  mutate(Abbr = str_replace(Abbr, "sd0R", "w0R")) |>
  mutate(Abbr = str_replace(Abbr, "sd0C", "w0C")) |>
  group_by(Scale, SubCompart, Species, Abbr) |>
  summarise(EqMass = sum(EqMass))

merged_SS_SB1 <- merge(SSsolve.R, SSsolve.excel, by="Abbr", suffixes = c(".R", ".Excel")) |>
  mutate(absdiff = EqMass.R-EqMass.Excel) |>
  mutate(reldiff = absdiff/EqMass.R)

print("Difference in emissions between R and Excel")

knitr::kable(merged_SS_SB1, format="markdown")

#Diff per "to" compartment
ggplot(merged_SS_SB1, aes (x = Abbr, y = reldiff)) +
  geom_boxplot() +
  ggtitle(paste0("Relative differences between steady state masses in excel and R (SB1solve) - ", substance)) +
  geom_hline(yintercept = 0.001, color="red") +
  geom_hline(yintercept = -0.001, color="red") 

sum(merged_SS_SB1$absdiff)

sum(merged_SS_SB1$EqMass.R)

sum(merged_SS_SB1$EqMass.Excel)

lakenames <- data.frame(SubCompart = c("lakesediment", "lakesediment"), Scale = c("Regional", "Continental"), Abbr = c("sd0R", "sd0C"), Species = c("Unbound", "Unbound"))

names <- SSsolve.R |>
  select(SubCompart, Scale, Abbr, Species) 

names <- rbind(names, lakenames)


```

```{r comparison of steady state emissions using SBsteady}

World$NewSolver("SBsteady")

SSsolve.R <- World$Solve(emissions)

SSsolve.excel <- read.xlsx(SBExcelName,
                             sheet=11,
                             colNames=TRUE,
                             rows=c(44,45))

SSsolve.excel <- SSsolve.excel |>
  select(-c(STEADY.STATE, X2)) |>
  pivot_longer(names_to = "Abbr", values_to = "EqMass", cols = everything()) 

SSsolve.R <- SSsolve.R |> mutate(Abbr =  paste0(accronym_map[SubCompart], 
                            accronym_map2[Scale])) |>
  mutate(SubCompart = str_replace(SubCompart, "lakesediment", "lake")) |>
  mutate(Abbr = str_replace(Abbr, "sd0R", "w0R")) |>
  mutate(Abbr = str_replace(Abbr, "sd0C", "w0C")) |>
  group_by(Scale, SubCompart, Species, Abbr) |>
  summarise(EqMass = sum(EqMass))

merged_SS_steady <- merge(SSsolve.R, SSsolve.excel, by="Abbr", suffixes = c(".R", ".Excel")) |>
  mutate(absdiff = EqMass.R-EqMass.Excel) |>
  mutate(reldiff =absdiff/EqMass.R)

print("Difference in emissions between R and Excel")

knitr::kable(merged_SS_steady, format="markdown")

#Diff per "to" compartment
ggplot(merged_SS_steady, aes (x = Abbr, y = reldiff)) +
  geom_boxplot() +
  ggtitle(paste0("Relative differences between steady state masses in excel and R (SBsteady) - ", substance)) +
  geom_hline(yintercept = 0.001, color="red") +
  geom_hline(yintercept = -0.001, color="red")

sum(merged_SS_steady$absdiff)

sum(merged_SS_steady$EqMass.R)

sum(merged_SS_steady$EqMass.Excel)
```
