---
title: "5.1 Area"
author: "Jaap Slootweg, Joris Quik"
date: "`r Sys.Date()`"
output: github_document
editor_options: 
  chunk_output_type: console
---

## Calculation of area of SubCompartment within Scales

The calculation of area slightly differs from the excel version, also in preparation of a local scale, and the wish to be able to situate the Continental/Regional/Local system within Tropic, rather than fixed within Moderate. Therefor the TotalArea contains the area including possibly nested areas. This is different from SYSTEMAREA in the excel version. We initiate World and start from the data TotalArea and FRACsea

```{r start.data, message=FALSE, warning=FALSE}
source("baseScripts/initTestWorld.R")
World$fetchData("TotalArea")
World$fetchData("FRACsea")

```

## Nesting and splitting land and sea

Regional and Arctic have no nested scale, and are straightforward calculation of AreaSea and AreaLand as resp. TotalArea\*FRACsea and TotalArea\*(1-FRACsea)

Continental contains Regional; the TotalArea of Continental is reduced by Regional, then the sea and land fraction are applied. Same procedure for Moderate with its nested Continental

```{r}
v_AreaSea <- World$NewCalcVariable("AreaSea")
tAreaSea <- World$CalcVar("AreaSea")
v_AreaLand <- World$NewCalcVariable("AreaLand")
tAreaLand <- World$CalcVar("AreaLand")
merge(tAreaLand, tAreaSea)
```

## Obvious and not so obvious variable references

Variable are often tables, as can be seen above for the AreaLand variable. When a variable is applied in a "defining function" the SBoo system looks for the proper dimension, e.g. when it finds Arealand and it is calculating for Arctic it will use the AreaLand of Arctic. But when calculating for instance AreaSea for Continental we need TotalArea for both Continental AND Regional! How can we implement this in our defining function?

In such a case use the "all." preposition. The function will receive the whole table for the variable at hand. As an example look the defining function for AreaSea:

```{r}
AreaSea
```

## The areas to be used in further calculations

All Scale/SubCompart combinations (present in in states) have an area, including the subcompart "cloudwater"! It receives the same area as air, namely the sum of AreaSea and AreaLand for the scale at hand. For sea and for oceans, if present, the area equal that of AreaSea . Otherwise (different Subcompartments that add up to "AreaLand") the calculation is straightforward (landFRAC \* AreaLand). Be aware that the definition of landFRAC differs from AREAFRAC; landFRAC is the fraction of the subcompartment of the AreaLand. With these different ways of calculation the formula to apply depends on the subcompartment, we need to apply another "trick"; we include SubCompartName as parameter in the defining function. We then use it to make the distinguish which formula applies. See the Area function below. In case you are not familiar with this: return() ends the function and "returns" its parameter. All different states are "peeled of" in order, and the last statements ensures that other cases (not existing states) are not included in calculations.

```{r}
Area
v_Area <- World$NewCalcVariable("Area")
tArea <- World$CalcVar("Area")
```

Just taking the sum of areas grouped by scale would include double counting the subcompartments which are on top of each other, or mixed: air / cloudwater / sea / deepocean! But we can test if the TotalArea of Arctic + Moderate + Tropic equals the total Area of air.

```{r}
TotAreaGlobalScales <- World$fetchData("TotalArea")
TotAreaGlobalScales <- TotAreaGlobalScales$TotalArea[TotAreaGlobalScales$Scale %in% c(
  "Arctic","Moderate","Tropic")]
TotAir <- World$fetchData("Area")
TotAir <- TotAir$Area[TotAir$SubCompart == "air"]
sum(TotAreaGlobalScales) == sum(TotAir)
```
