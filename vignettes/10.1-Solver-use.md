SteadyState Solver use
================
Valerie de Rijk, Joris Quik, Jaap Slootweg
2024-12-19

SimpleBox (SBoo) has specific solvers available that allow running the
model deterministic or probabilistic. We assume you already understand
the basics of using SimpleBox and have an idea of what input variables
or emissions you want to input with a certain degree of uncertainty or
variability. There are basically three types of solvers to use here:

1.  SteadyState solver for running the model for a substances with one
    set of emissions and variables.
2.  Deterministic dynamic solver for running the model for a substance
    with one set of emissions in time and one set of variables.
3.  [UncertainSolver](vignettes/10.2-Uncertain-solver-use.md) for
    running the model probabilistically (n times) calculating steady
    state output (mass/concentration) based on a distribution of
    emissions and or input variables.
4.  [UncertainDynamicSolver](vignettes/10.3-Uncertain-dynamic-solver-use.md)
    for running the model probabilistically (n times) calculating
    dynamic output based on temporal emissions.

Below is an example of using the SteadyState solver. The others can be
found in their respective vignettes.

## Initialisation

We assume you have the input data for a substance or material of
interest and all the data describing the SimpleBox world to be created
ready and thus can run the initWorld script.

``` r
source("baseScripts/initWorld_onlyMolec.R")
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.4     ✔ readr     2.1.5
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.1
    ## ✔ ggplot2   3.5.1     ✔ tibble    3.2.1
    ## ✔ lubridate 1.9.3     ✔ tidyr     1.3.1
    ## ✔ purrr     1.0.2     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
    ## 
    ## Attaching package: 'ggdag'
    ## 
    ## 
    ## The following object is masked from 'package:stats':
    ## 
    ##     filter
    ## 
    ## 
    ## 
    ## Attaching package: 'rlang'
    ## 
    ## 
    ## The following objects are masked from 'package:purrr':
    ## 
    ##     %@%, flatten, flatten_chr, flatten_dbl, flatten_int, flatten_lgl,
    ##     flatten_raw, invoke, splice
    ## 
    ## 
    ## Loading required package: foreach
    ## 
    ## 
    ## Attaching package: 'foreach'
    ## 
    ## 
    ## The following objects are masked from 'package:purrr':
    ## 
    ##     accumulate, when
    ## 
    ## 
    ## Loading required package: iterators
    ## 
    ## Joining with `by = join_by(Matrix)`
    ## Joining with `by = join_by(Compartment)`

    ## Warning in private$FetchData(varname): Cannot find property kdis ; but found

    ## Warning in eval(ei, envir): kdis is missing, setting kdis = 0

    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all SubCompartName
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## to.SubCompartName in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## from.SubCompartName in FromAndTo property

    ## Warning in dplyr::inner_join(AllIn, private$MyCore$states$asDataFrame, join_by(toScale == : Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 1 of `x` matches multiple rows in `y`.
    ## ℹ Row 95 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

    ## Warning in dplyr::inner_join(AllIn, private$MyCore$states$asDataFrame, join_by(toScale == : Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 1 of `x` matches multiple rows in `y`.
    ## ℹ Row 189 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

    ## Warning in private$UpdateDL(CanDo[i]): rad_species ; no rows calculated

    ## Warning in private$UpdateDL(CanDo[i]): rho_species ; no rows calculated

    ## Warning in (function (Kow, pKa, CorgStandard, ChemClass, a, b, all.rhoMatrix, :
    ## pKa is needed but missing, setting pKa=7

    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## to.FracROWatComp in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## to.SubCompartName in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all Matrix in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all to.rhoMatrix
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all to.RadCP in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all to.RhoCP in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all from.RhoCP in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all FRACs in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## to.SubCompartName in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## from.SubCompartName in FromAndTo property

    ## Warning in private$UpdateDL(CanDo[i]): SettlingVelocity ; no rows calculated

    ## Warning in dplyr::inner_join(AllIn, private$MyCore$states$asDataFrame, join_by(toScale == : Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 1 of `x` matches multiple rows in `y`.
    ## ℹ Row 1 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

    ## Warning in dplyr::inner_join(AllIn, private$MyCore$states$asDataFrame, join_by(toScale == : Detected an unexpected many-to-many relationship between `x` and `y`.
    ## Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 1 of `x` matches multiple rows in `y`.
    ## ℹ Row 142 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

    ## Warning in private$Execute(debugAt): input data ignored; not all FRinw in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all to.MTC_2w in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all from.MTC_2w in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all to.FRorig in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all to.Matrix in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all to.Area in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## from.SubCompartName in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## to.SubCompartName in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all Matrix in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all SubCompartName
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all MTC_2w in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## to.SubCompartName in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property
    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## to.FracROWatComp in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all Volume in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## to.SubCompartName in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all Matrix in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all FRinw in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all from.RhoCP in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all from.RadCP in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all SubCompartName
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## to.SubCompartName in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all to.MTC_2w in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all from.FRorig in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all FRinw in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all Matrix in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all
    ## from.SubCompartName in FromAndTo property

    ## Warning in dplyr::inner_join(AllIn, private$MyCore$states$asDataFrame, join_by(fromScale == : Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 1 of `x` matches multiple rows in `y`.
    ## ℹ Row 48 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

    ## Warning in dplyr::inner_join(AllIn, private$MyCore$states$asDataFrame, join_by(toScale == : Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 1 of `x` matches multiple rows in `y`.
    ## ℹ Row 142 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

    ## Warning in dplyr::inner_join(AllIn, private$MyCore$states$asDataFrame, join_by(toScale == : Detected an unexpected many-to-many relationship between `x` and `y`.
    ## Detected an unexpected many-to-many relationship between `x` and `y`.
    ## Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 1 of `x` matches multiple rows in `y`.
    ## ℹ Row 1 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

    ## Warning in dplyr::inner_join(AllIn, private$MyCore$states$asDataFrame, join_by(toScale == : Detected an unexpected many-to-many relationship between `x` and `y`.
    ## Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 1 of `x` matches multiple rows in `y`.
    ## ℹ Row 48 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

    ## Warning in dplyr::inner_join(AllIn, private$MyCore$states$asDataFrame, join_by(toScale == : Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 1 of `x` matches multiple rows in `y`.
    ## ℹ Row 142 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

    ## Warning in private$Execute(debugAt): input data ignored; not all Volume in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all VertDistance
    ## in FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all FRorig in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all to.Area in
    ## FromAndTo property

    ## Warning in private$Execute(debugAt): input data ignored; not all from.Area in
    ## FromAndTo property

## *NewSolver*

*Different solvers are available, generating output starts with defining
the solver you want to use by `world$NewSolver("[name of s_function]")`*

### *SBsteady*

``` r
World$NewSolver("SBsteady")
```

*What solving means is that using matrix algebra a set of differential
equations is solved:*

*`K %*% m + e`*

*Where:*

*K is the matrix of rate constants for each process describing the mass
transfers to and from and out of a state (e.g. substance in freshwater
(w1U) or small heteroagglomerate in natural soil (s1A)).*

*m is the mass in each compartment, e.g. 0 at t=0.*

*e is the emission to each compartment per unit of time, e.g. 1 t/y.*

*To solve this set of differential equations we thus need an emission,
e.g. 1 ton/year to air.*

``` r
emissions <- data.frame(Abbr = "aCU", Emis = 1000/(365.25*24*60*60)) # convert 1 t/y to si units: kg/s

# TODO: explain what is the reason for this Abbr? Why is it not a relational table defining scale, compartment and species as for all other data?
```

*Now er are ready to run the solver, which results in the mass in each
compartment.*

``` r
World$Solve(emissions)
```

    ## Warning in private$solver$PrepKaasM(): 12 k values equal to 0; removed for
    ## solver

## *DynApproxSolve*

The DynApproxSolve solver is used to solve the matrix dynamically using
approx functions.

The emissions can be delivered to the solver in two formats: 1. A
dataframe with three columns: Abbr, Emis and Timed 2. A list with approx
functions for each compartment that has emissions

### 1: Dataframe with emissions

Create a dataframe with emissions

``` r
emissions <- data.frame(Abbr = c("aRU", "s2RU", "w1RU","aRU", "s2RU", "w1RU"), Emis = c(10, 10, 10,20, 20, 20), Timed = c(1, 2, 3, 4, 5, 6)) # convert 1 t/y to si units: kg/s

emissions <- emissions |>
  mutate(Timed = Timed*(365.25*24*60*60)) |> ungroup()

tmax <- 365.25*24*60*60*10
times <- seq(0, tmax, length.out = 10)
```

Solve using the dynamic solver

``` r
World$NewSolver("DynApproxSolve")
solved <- World$Solve(tmax = tmax, emissions, needdebug = F)
```

    ## Warning in private$solver$PrepKaasM(): 12 k values equal to 0; removed for
    ## solver

### 2: List with approx functions

Create a list of approx funs using the emission df created in the
previous step:

``` r
SBEmissions3 <- 
  emissions |> 
  group_by(Abbr) |> 
  summarise(n=n(),
            EmisFun = list(
              approxfun(
                data.frame(Timed = c(0,Timed), 
                           Emis=c(0,Emis)),
                rule = 2) # Change to rule 1:1 for no extrapolation
            )
  )

funlist <- SBEmissions3$EmisFun
names(funlist) <- SBEmissions3$Abbr
```

Plot the approx funs

``` r
times <- seq(0, 25*365.25*24*3600, by=10000)
PlotEmis <- funlist[["s2RU"]]
values <- sapply(times, PlotEmis)

plot(times, values, type = "l", lwd=2)
```

![](10.1-Solver-use_files/figure-gfm/Plot%20approx%20funs-1.png)<!-- -->

Solve the matrix

``` r
World$NewSolver("DynApproxSolve")
solved <- World$Solve(tmax = tmax, funlist, needdebug = F)
```

    ## Warning in private$solver$PrepKaasM(): 12 k values equal to 0; removed for
    ## solver

### Plot the outcomes

``` r
sol <- data.frame(solved) |>
  select(!starts_with("emis")) |>
  pivot_longer(cols = -c("time"),
               names_to = "Abbr",
               values_to = "Mass") |>
  mutate(time = time/(365.25*24*3600))

Abbrs <- c("a", "s", "w")

plot_theme <-  theme(
    axis.title.x = element_text(size = 12),    
    axis.title.y = element_text(size = 12),    
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),     
    axis.text.y = element_text(size = 12),
    title = element_text(size=16)
  )

for(i in Abbrs){
  df <- sol |>
    filter(startsWith(Abbr, i)) 
  
  p1 <- ggplot(df, mapping = aes(x = time, y = Mass, colour = Abbr)) +
    geom_line() + 
    plot_theme +
    labs(x = "Time (years)",
           y = "Mass (kg)") +
    ggtitle("Masses over time") 
  print(p1)

}
```

![](10.1-Solver-use_files/figure-gfm/Plot%20outcomes-1.png)<!-- -->![](10.1-Solver-use_files/figure-gfm/Plot%20outcomes-2.png)<!-- -->![](10.1-Solver-use_files/figure-gfm/Plot%20outcomes-3.png)<!-- -->
