---
title: "Solver script"
author: "Valerie de Rijk, Joris Quik, Jaap Slootweg"
date: "`r Sys.Date()`"
output: github_document
editor_options: 
  chunk_output_type: console
---

## *Initiation*

*We assume you have the input data for a substance or material of interest and all the data describing the SimpleBox world to be created ready and thus can run the initWorld script.*

```{r}
library(dplyr)
source("baseScripts/initWorld_onlyMolec.R")
```

## *NewSolver*

*Different solvers are available, basically:*

1.  *Solving the steadystate of the SimpleBox world*

2.  *Solving in time the states of SimpleBox world*

*Both will be illustrated bellow, but it starts with defining the solver you want to use by `world$NewSolver("[name of s_function]")`*

### *SBsteady*

```{r SBsteady}
World$NewSolver("SBsteady")
```

*What solving means is that using matrix algebra a set of differential equations is solved:*

*`K %*% m + e`*

*Where:*

*K is the matrix of rate constants for each process describing the mass transfers to and from and out of a state (e.g. substance in freshwater (w1U) or small heteroagglomerate in natural soil (s1A)).*

*m is the mass in each compartment, e.g. 0 at t=0.*

*e is the emission to each compartment per unit of time, e.g. 1 t/y.*

*To solve this set of differential equations we thus need an emission, e.g. 1 ton/year to air.*

```{r constant emission}
emissions <- data.frame(Abbr = "aCU", Emis = 1000/(365.25*24*60*60)) # convert 1 t/y to si units: kg/s

# TODO: explain what is the reason for this Abbr? Why is it not a relational table defining scale, compartment and species as for all other data?
```

*Now er are ready to run the solver, which results in the mass in each compartment.*

```{r}
World$Solve(emissions)
```

## *DynApproxSolve*

The DynApproxSolve solver is used to solve the matrix dynamically using approx functions. 

The emissions can be delivered to the solver in two formats: 
1. A dataframe with three columns: Abbr, Emis and Timed
2. A list with approx functions for each compartment that has emissions

### 1: Dataframe with emissions

Create a dataframe with emissions
```{r Dataframe with emissions}
emissions <- data.frame(Abbr = c("aRU", "s2RU", "w1RU","aRU", "s2RU", "w1RU"), Emis = c(10, 10, 10,20, 20, 20), Timed = c(1, 2, 3, 4, 5, 6)) # convert 1 t/y to si units: kg/s

emissions <- emissions |>
  mutate(Timed = Timed*(365.25*24*60*60)) |> ungroup()

tmax <- 365.25*24*60*60*10
times <- seq(0, tmax, length.out = 10)

```

Solve using the dynamic solver
```{r Solve for emission df}
World$NewSolver("DynApproxSolve")
solved <- World$Solve(tmax = tmax, emissions, needdebug = F)
```

### 2: List with approx functions 

Create a list of approx funs using the emission df created  in the previous step:

```{r Make list of approx funs}
SBEmissions3 <- 
  emissions |> 
  group_by(Abbr) |> 
  summarise(n=n(),
            EmisFun = list(
              approxfun(
                data.frame(Timed = c(0,Timed), 
                           Emis=c(0,Emis)),
                rule = 2) # Change to rule 1:1 for no extrapolation
            )
  )

funlist <- SBEmissions3$EmisFun
names(funlist) <- SBEmissions3$Abbr

```

Plot the approx funs
```{r Plot approx funs}
times <- seq(0, 25*365.25*24*3600, by=10000)
PlotEmis <- funlist[["s2RU"]]
values <- sapply(times, PlotEmis)

plot(times, values, type = "l", lwd=2)
```

Solve the matrix
```{r Solve using list of approx funs}

World$NewSolver("DynApproxSolve")
solved <- World$Solve(tmax = tmax, funlist, needdebug = F)
```

### Plot the outcomes

```{r Plot outcomes}
sol <- data.frame(solved) |>
  select(!starts_with("emis")) |>
  pivot_longer(cols = -c("time"),
               names_to = "Abbr",
               values_to = "Mass") |>
  mutate(time = time/(365.25*24*3600))

Abbrs <- c("a", "s", "w")

plot_theme <-  theme(
    axis.title.x = element_text(size = 12),    
    axis.title.y = element_text(size = 12),    
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),     
    axis.text.y = element_text(size = 12),
    title = element_text(size=16)
  )

for(i in Abbrs){
  df <- sol |>
    filter(startsWith(Abbr, i)) 
  
  p1 <- ggplot(df, mapping = aes(x = time, y = Mass, colour = Abbr)) +
    geom_line() + 
    plot_theme +
    labs(x = "Time (years)",
           y = "Mass (kg)") +
    ggtitle("Masses over time")
  print(p1)

}

```

