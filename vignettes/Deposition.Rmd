---
title: "Deposition Processes"
author: "JQ"
date: "2023-08-22"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
knitr::knit_meta()
# knitr::opts_chunk$set(echo = TRUE)
projectRoot <- paste(getwd(), "..", sep = "/")
knitr::opts_knit$set(root.dir = projectRoot) #assuming vignette is in a direct subfolder of the project
```

## INTERMEDIA TRANSFER

The intermedia transfer processes are related to transport from air to soil/water and from water to sediment, and vice versa. Also transport from soil to water.

Another vignette describes the flows related to diffusion processes (DiffusionProcesses.Rmd) and other intermedia transfer coefficients (OtherInterMedia.Rmd)

### Preparation

We initialise a "World" and calculate the needed parameters.

```{r initiate, echo=TRUE, message=FALSE, warning=TRUE}
#we initialize the test environment with the default substance, therefor we remove possible earlier value
rm(substance)
#script to initialize test environment, including faking a future 'library(sboo)'
#init default core (World) with classic states, and classic kaas
try (source("baseScripts/initTestWorld.R"))

#we need the partitioning
source("testScripts/initPartitioningVariables.R")
#calculation of the needed SB variables, first compiling their defining functions

# non variable input data which is calculated (see partioning.Rmd) needs to be available before you can proceed



```


```{r eval=FALSE, include=FALSE}
# This needs to be calculated first:
World$NewCalcVariable("FRACa")
World$CalcVar("FRACa")
World$NewCalcVariable("FRACw")
World$CalcVar("FRACw")
World$NewCalcVariable("FRACs")
World$CalcVar("FRACs")
# World$fetchData()

RHOsolid <- with(World$fetchData("rhoMatrix"),
                                    rhoMatrix[SubCompart == "othersoil"])

source("newAlgorithmScripts/f_kdegcalc.R")
kdeg.sediment <- f_kdegcalc(Q.10 = World$fetchData("Q.10"), 
                          Ksw = World$fetchData("Ksw"), 
                          Biodeg = "r", 
                          C.OHrad.n = World$fetchData("C.OHrad.n"), 
                          Ea.OHrad = World$fetchData("Ea.OHrad"), 
                          k0.OHrad = World$fetchData("k0.OHrad"),
                          CorgStandard = World$fetchData("CorgStandard"), 
                          RHOsolid = RHOsolid,
                          Matrix = "sediment")

#FromData <- World$fetchData("Globals")
#FromData$kdeg.sediment <- kdeg.sediment
#World$UpdateData(FromData, keys = T, TableName = "Globals")

World$NewCalcVariable("Kp")
World$CalcVar("Kp")

World$NewCalcVariable("D")
World$CalcVar("D")
World$NewCalcVariable("KpCOL")
World$CalcVar("KpCOL")

World$NewCalcVariable("Kacompw")
World$CalcVar("Kacompw")

World$NewCalcVariable("FRinw")
World$CalcVar("FRinw")

World$NewCalcVariable("Kaerw")
World$CalcVar("Kaerw")
World$NewCalcVariable("Kaers")
World$CalcVar("Kaers")

World$NewCalcVariable("FRingas")
World$CalcVar("FRingas")

# So, degradation is needed here? Are we sure?

# source("newAlgorithmScripts/k_Degradation.R")

# Read in function to derive the temperature correction factor, now a SB variable
Tempfactor

# World$NewCalcVariable("k_Degradation")
# World$CalcVar("k_Degradation")
```


## Deposition

One part of the function to get the transfer from air to the land surface is calculating the deposition rate constant. This is done using a large function k_MeanDep.R

First we try to see of all variables are available for calculating the deposition rate constant:

```{r MEAN deposition, echo=TRUE}

World$fetchData("FRingas")
World$fetchData("WINDspeed")
World$fetchData("VertDistance")
World$fetchData("twet")
World$fetchData("tdry")
World$fetchData("COLLECTeff")
World$fetchData("AEROSOLdeprate")
World$fetchData("Kacompw")
World$fetchData("FRorig")
World$fetchData("SpeciesName")

World$fetchData("RAINrate")

try(World$fetchData("OtherkAir")) # this one is probably missing

World$fetchData("Area")

World$fetchData("Kaers")
World$fetchData("Kaerw")
World$fetchData("FRACa")
World$fetchData("FRACw")
World$fetchData("FRACs")

World$fetchData("FRinaerw")
World$fetchData("FRinaers")



```

```{r}
#fill another relevant k for OtherkAir
testDegradation <-  World$NewProcess("k_Degradation")
World$UpdateKaas(mergeExisting = F)

#only now we can calculate OtherkAir, because:
World$fetchData("kaas") #this is not the regular use!! see method kaas of World !!
source("newAlgorithmScripts/v_OtherkAir.R")
testtm <- World$NewCalcVariable("OtherkAir")
#testtm$execute()
World$CalcVar("OtherkAir")

```

Then the deposition rate constant can be calculated

```{r}
# source("newAlgorithmScripts/k_Deposition.R")

testClass <- World$NewProcess("k_Deposition")
testClass$execute()

testClass$execute(debugAt = list())

World$FromDataAndTo(processName = "k_Deposition")

testClass$execute(debugAt = list()) #an empty list always triggers
testClass$execute(debugAt = list(Scale = "Regional", Substance = "Molecular"))
#The actual execution of the proces:
testClass$execute()
```

